<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Show de Pr√™mios</title>
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte Inter do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados */
        body { font-family: 'Inter', sans-serif; }

        /* Anima√ß√µes */
        @keyframes logo-glow {
            0%, 100% { filter: drop-shadow(0 0 4px #FFD700); transform: scale(1); }
            55% { filter: drop-shadow(0 0 12px #fef08a); transform: scale(1.05); }
        }
        .logo-animation {
            animation: logo-glow 3s ease-in-out infinite;
        }

        @keyframes bounce-in {
            0% { transform: translateY(-200px) scale(0.5); opacity: 0; }
            50% { transform: translateY(0) scale(1.1); opacity: 1; }
            70% { transform: translateY(-30px) scale(0.95); }
            90% { transform: translateY(0) scale(1.05); }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        .animate-bounce-in { animation: bounce-in 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }

        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pop-up { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
        .modal-content { animation: pop-up 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        
        @keyframes shake-error {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        .animate-shake-error { animation: shake-error 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        
        /* Estilo para Rodada Conclu√≠da (cinza/opaca) */
        .game-completed-style {
            opacity: 0.5;
            background-color: #374151 !important; /* Cor de fundo cinza escuro */
            border: 1px solid #4b5563;
            transition: all 0.5s;
        }
        
        .animate-flash-complete { animation: flash-complete-dark 1s ease-out; }
        @keyframes flash-complete-dark {
            0%, 100% { background-color: #1f2937; }
            50% { background-color: #10b981; }
        }
        
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }

        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
        }
        .active-round-highlight {
            animation: none; /* Remove a anima√ß√£o de pulso */
            border: 2px solid #10b981;
            transform: scale(1.02); /* Leve destaque visual */
            opacity: 1 !important; /* Garante que fique totalmente vis√≠vel */
        }

        @keyframes fall-in-ball {
            0% { transform: scale(0.3); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .ball-fall-in {
            animation: fall-in-ball 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        
        /* ANIMA√á√ÉO DO GLOBO E CICLONE DE N√öMEROS */
        @keyframes spin-cage {
            from { transform: rotateY(0deg) rotateX(10deg); }
            to { transform: rotateY(360deg) rotateX(10deg); }
        }
        .spinning-cage {
            transform-style: preserve-3d;
            animation: spin-cage 0.5s linear infinite;
        }
        .number-cyclone-particle {
            position: absolute;
            color: white;
            font-weight: 900;
            opacity: 0.7;
            transform-style: preserve-3d;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
        }
        @keyframes fly-in-cage-1 {
            0% { transform: translate3d(0, 0, 0) rotateY(0deg); }
            100% { transform: translate3d(50px, 80px, 150px) rotateY(360deg); }
        }
        @keyframes fly-in-cage-2 {
            0% { transform: translate3d(0, 0, 0) rotateX(0deg); }
            100% { transform: translate3d(-80px, -120px, 100px) rotateX(360deg); }
        }
        @keyframes fly-in-cage-3 {
            0% { transform: translate3d(0, 0, 0) rotateZ(0deg); }
            100% { transform: translate3d(150px, -90px, -50px) rotateZ(360deg); }
        }
        @keyframes fly-in-cage-4 {
            0% { transform: translate3d(0, 0, 0) rotateX(0deg) rotateY(0deg); }
            100% { transform: translate3d(-120px, 140px, -80px) rotateX(-360deg) rotateY(360deg); }
        }
        
        /* ANIMA√á√ÉO DO MARTELO DO LEIL√ÉO (Aprimorada) */
        @keyframes gavel-strike-impact {
            0% { transform: rotate(25deg); }
            50% { transform: rotate(-45deg) scale(1.1); }
            70% { transform: rotate(0deg) scale(1.4); } /* Impacto */
            90% { transform: rotate(10deg) scale(1.1); } /* Recuo */
            100% { transform: rotate(0deg); }
        }
        .animate-gavel-strike {
            display: inline-block !important;
            animation: gavel-strike-impact 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            transform-origin: bottom right; /* Ponto de rota√ß√£o aprimorado */
        }

        /* Estilos espec√≠ficos para ordenar as rodadas: Ativa no topo, Completa no final */
        #games-list {
            display: flex;
            flex-direction: column;
        }
        .game-item {
            order: 2; /* Padr√£o: Rodadas n√£o iniciadas ficam no meio */
        }
        .game-item.active-round-highlight {
            order: 1; /* Rodada Ativa: vai para o topo */
        }
        .game-item.game-completed-style {
            order: 3; /* Rodada Conclu√≠da: vai para o final */
        }

        /* Estilo para aplicar o zoom din√¢mico ao Painel de N√∫meros */
        #bingo-board-wrapper {
            transition: transform 0.3s ease-in-out;
            transform-origin: top center; /* Garante que a escala comece do topo */
        }
        
        /* Estilo para aplicar o zoom din√¢mico ao N√∫mero Anunciado */
        #current-number-wrapper {
            transition: transform 0.3s ease-in-out;
            transform-origin: center; /* Garante que o zoom seja a partir do centro */
        }

        /* Anima√ß√£o de flash para o sorteio autom√°tico */
        @keyframes custom-flash {
            0% { opacity: 0.5; }
            50% { opacity: 1.0; transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .animate-custom-flash { 
            animation: custom-flash 0.3s ease-out; 
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
        }
        
        /* Estilo base para o n√∫mero anunciado */
        #current-number {
             -webkit-text-stroke: 2px #000000; 
             color: #FFFFFF; 
             text-shadow: none !important; 
        }

        /* Novo estilo para o n√∫mero flutuante do sorteio autom√°tico */
        .autodraw-display {
            font-size: clamp(10rem, 30vw, 20rem); 
            line-height: 1; 
            text-shadow: 2px 2px 5px #000;
        }

        /* Estilo para o modal de Encerramento/Break (Corrigido para evitar scroll da p√°gina) */
        #event-break-modal .modal-content {
            max-height: 95vh;
            width: 95vw;
        }

        [contenteditable="true"]:empty:before { content: attr(placeholder); color: #6b7280; pointer-events: none; display: block; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; pointer-events: none; }
        .bingo-cell, .winner-card { cursor: pointer; }

        /* Esconde o seletor de cor padr√£o */
        input[type="color"] { -webkit-appearance: none; appearance: none; border: none; width: 24px; height: 24px; cursor: pointer; background-color: transparent; padding: 0; }
        /* Estiliza a "bolha" de cor */
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid #9ca3af; border-radius: 50%; }

    </style>
</head>
<body class="bg-gray-900 text-white">

    <canvas id="confetti-canvas"></canvas>
    
    <div class="flex flex-col min-h-screen">
        <header class="text-center py-4 flex-shrink-0 relative mt-6">
            <div class="flex flex-col items-center justify-center">
                <!-- App Logo (ser√° preenchido dinamicamente) -->
                <div id="app-logo" class="w-16 h-16 sm:w-20 sm:h-20 mb-2">
                    <!-- O logo customizado ser√° inserido aqui, ou o SVG padr√£o ser√° mostrado -->
                </div>
                
                <div id="main-title" contenteditable="true" class="text-2xl sm:text-3xl font-black text-sky-400 leading-tight focus:outline-none focus:ring-2 ring-sky-500 rounded-lg px-2">
                    <!-- Ser√° preenchido pelo JS -->
                </div>
                 <div id="connection-indicator" class="flex items-center justify-center gap-2 px-3 py-1 rounded-lg text-white text-xs font-bold transition-all duration-500 bg-red-500 mt-2 mx-auto">
                    <div class="w-2 h-2 rounded-full bg-white"></div>
                    <span id="connection-status-text" data-label-key="connectionIndicatorDisconnected">Desconectado</span>
                </div>
            </div>
        </header>

        <!-- A classe grid agora define o layout principal -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6 p-4 sm:p-6">
            
            <!-- BARRA LATERAL ESQUERDA: V√çDEO, CONTROLES GERAIS E VENCEDORES -->
            <aside class="lg:col-span-1 bg-gray-800 rounded-2xl shadow-2xl p-6 flex flex-col">
                
                <!-- 1. COMO USAR? (TOPO ESQUERDO, AGORA PADRONIZADO) -->
                <div class="bg-gray-800 p-0 rounded-xl mb-4 flex-shrink-0">
                    <h3 class="text-base font-bold text-sky-400 mb-3 text-center" data-label-key="howToUseTitle">üé¨ Como Usar?</h3>
                    <!-- Campo de link escondido para salvar o valor no estado -->
                    <input type="hidden" id="tutorial-link-input">
                    
                    <button id="show-tutorial-btn" disabled class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg text-sm transition-all shadow-lg cursor-not-allowed" data-label-key="howToUseButton">Em Breve!</button>
                </div>

                <!-- NOVO: Hist√≥rico de Vers√µes -->
                <button id="show-changelog-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg transition-all mb-4 flex-shrink-0" data-label-key="versionHistoryButton">Hist√≥rico de Vers√µes</button>

                <!-- NOVO: Bot√£o de Configura√ß√µes de Personaliza√ß√£o -->
                <button id="show-settings-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg transition-all mb-4 flex-shrink-0" data-label-key="customizeButton">Personalizar</button>

                <!-- 2. BOT√ïES DE CONTROLE GERAIS -->
                <div class="flex flex-col gap-2 mb-4 flex-shrink-0">
                    <button id="interval-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg transition-all" data-label-key="intervalButton">Intervalo</button>
                    <button id="share-btn" class="hidden w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl text-base shadow-lg transition-all" data-label-key="generateProofButton">Gerar Prova</button>
                    <button id="end-event-btn" class="hidden w-full bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg transition-all" data-label-key="endEventButton">Encerrar Evento</button>
                    <button id="reset-event-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg transition-all" data-label-key="resetEventButton">Reiniciar Evento</button>
                </div>

                <!-- LEGENDA DE ATALHOS -->
                <div id="shortcuts-legend" class="mt-4 flex-shrink-0">
                    <h3 class="text-base font-bold text-sky-400 mb-3 text-center" data-label-key="quickShortcutsTitle">Atalhos R√°pidos</h3>
                    <ul id="shortcuts-legend-list" class="space-y-2 text-xs text-slate-400 pl-4">
                        <!-- Conte√∫do din√¢mico via JS -->
                    </ul>
                </div>

                <!-- 3. VENCEDORES (LISTA FLEX√çVEL E SCROLL√ÅVEL) -->
                <h2 class="text-2xl font-bold text-slate-300 mb-2 flex-shrink-0 mt-4" data-label-key="winnersTitle">Vencedores</h2>
                <!-- Removendo max-h: [85vh] -->
                <div id="winners-container" class="space-y-4 flex-grow overflow-y-auto pr-2"></div>

            </aside>

            <!-- COLUNA CENTRAL: PAINEL, N√öMERO ANUNCIADO E BRINDES -->
            <div class="lg:col-span-3 flex flex-col gap-6">
                <!-- PAINEL DE N√öMEROS -->
                <section class="p-4 bg-gray-800 rounded-2xl shadow-xl">
                    <h2 class="text-xl font-bold mb-4 text-center text-slate-300" data-label-key="bingoBoardTitle">Painel de N√∫meros</h2>
                    
                    <!-- INDICADOR DE RODADA ATIVA -->
                    <div id="current-round-display" class="text-lg font-bold text-center text-sky-400 bg-gray-700 py-2 rounded-lg mb-4 transition-all shadow-inner">
                        <!-- Conte√∫do din√¢mico via JS -->
                    </div>
                    
                    <!-- NOVO: Wrapper para aplicar o zoom (com overflow-x-auto para evitar sobreposi√ß√£o) -->
                    <div id="bingo-board-wrapper" class="w-full mx-auto overflow-x-auto">
                        <!-- AQUI AS LETRAS B-I-N-G-O/A-J-U-D-E SER√ÉO RENDERIZADAS DINAMICAMENTE -->
                        <div id="bingo-board" class="grid grid-cols-10 gap-x-2 sm:gap-x-4 min-w-max"></div>
                    </div>

                    <div class="mt-4 grid grid-cols-3 gap-2">
                         <button id="auto-draw-btn-bottom" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl text-sm shadow-lg transition-transform transform hover:scale-105" data-label-key="autoDrawButton">Sorteio Autom√°tico</button>
                         <button id="verify-btn-bottom" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl text-sm shadow-lg transition-transform transform hover:scale-105" data-label-key="verifyButton">Verificar</button>
                         <button id="clear-round-btn-bottom" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-xl text-sm shadow-lg transition-transform transform hover:scale-105" data-label-key="clearRoundButton">Limpar Rodada Atual</button>
                    </div>
                </section>
                
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-center">
                    <!-- CONTROLES -->
                    <div id="controls-panel-left" class="lg:col-span-1 bg-gray-800 rounded-2xl p-4 w-full mx-auto flex flex-col">
                        <div id="clock" class="text-center text-2xl font-bold text-slate-300 mb-2"></div>
                        <h2 class="text-lg font-bold text-slate-300 mb-3 text-center" data-label-key="controlsPanelTitle">Controles</h2>
                        
                        <!-- Slider de Zoom PAINEL DE N√öMEROS -->
                        <div class="mb-3">
                            <label for="board-zoom-slider" class="block text-xs font-bold text-slate-400 mb-1" data-label-key="boardScaleLabel">Escala Painel N√∫meros</label>
                            <input type="range" id="board-zoom-slider" min="50" max="150" value="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                        </div>

                        <!-- Slider de Zoom N√öMERO ANUNCIADO -->
                        <div class="mb-3">
                            <label for="display-zoom-slider" class="block text-xs font-bold text-slate-400 mb-1" data-label-key="displayScaleLabel">Escala N√∫mero Anunciado</label>
                            <input type="range" id="display-zoom-slider" min="50" max="150" value="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                        </div>


                        <form id="manual-input-form" class="flex flex-col gap-2 mb-3">
                            <div class="flex items-center gap-1">
                                <input type="text" id="letter-input" placeholder="L" maxlength="1" class="text-center text-sm uppercase font-bold w-10 p-2 border-2 border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input type="number" id="number-input" placeholder="N¬∫" class="text-center text-sm font-bold flex-grow p-2 border-2 border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" min="1" max="75">
                            </div>
                            <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold p-2 rounded-lg text-sm shadow-lg" data-label-key="manualAnnounceButton">Anunciar Manual</button>
                        </form>
                        <p id="error-message" class="text-red-500 font-bold h-5 mb-1 text-xs text-center"></p>
                        <div class="grid grid-cols-1 gap-2">
                            <button id="auto-draw-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 text-xs rounded-lg shadow-lg" data-label-key="autoDrawButton">Sorteio Autom√°tico</button>
                            <button id="verify-btn-top" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 text-xs rounded-lg shadow-lg" data-label-key="verifyButton">Verificar</button>
                            <button id="start-new-round-btn" class="hidden w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 text-xs rounded-lg shadow-lg" data-label-key="clearRoundButton">Limpar Rodada Atual</button>
                        </div>
                    </div>
                    
                    <!-- N√öMERO ANUNCIADO -->
                    <div class="lg:col-span-3 bg-gray-800 rounded-2xl shadow-2xl p-6 flex flex-col justify-center items-center">
                        <p id="main-display-label" class="text-xl sm:text-2xl font-bold text-slate-400 tracking-wider uppercase" data-label-key="announcedNumberLabel">N√∫mero Anunciado</p>
                        <!-- Wrapper do Zoom para o N√∫mero Anunciado -->
                        <div id="current-number-wrapper" class="my-4 flex justify-center items-center w-full">
                            <div id="current-number" class="font-black text-gray-800 flex justify-center items-center gap-x-2 sm:gap-x-4 w-64 h-64 sm:w-[420px] sm:h-[420px] rounded-full bg-slate-50 shadow-inner" style="font-size: clamp(6rem, 25vw, 15rem); line-height: 1; visibility: hidden;"></div>
                        </div>
                        <div class="mt-4 text-center">
                            <h3 class="text-xl font-bold text-slate-300 mb-3" data-label-key="lastNumbersLabel">√öltimos 5 N√∫meros</h3>
                            <div id="last-numbers-display" class="flex flex-wrap justify-center gap-4"></div>
                        </div>
                    </div>
                    
                    <!-- SORTEIO DE BRINDES -->
                    <div id="prize-draw-section" class="lg:col-span-1 bg-gray-800 rounded-2xl p-4 w-full mx-auto flex flex-col">
                        <h2 class="text-lg font-bold text-slate-300 mb-3 text-center" data-label-key="prizeDrawTitle">Sorteio de Brindes</h2>
                        <form id="prize-draw-form" class="flex flex-col gap-2 flex-grow">
                             <button type="button" id="check-drawn-prizes-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg text-xs shadow-lg mb-1" data-label-key="checkDrawnPrizesButton">Conferir Sorteados</button>
                            <div class="flex flex-col gap-1">
                                <label for="prize-draw-min" class="text-xs text-slate-400" data-label-key="prizeDrawFromLabel">De:</label>
                                <input type="number" id="prize-draw-min" value="1" class="w-full text-center text-base font-bold p-2 border-2 border-gray-600 bg-gray-700 rounded-lg">
                                <label for="prize-draw-max" class="text-xs text-slate-400 mt-1" data-label-key="prizeDrawToLabel">At√©:</label>
                                <input type="number" id="prize-draw-max" value="500" class="w-full text-center text-base font-bold p-2 border-2 border-gray-600 bg-gray-700 rounded-lg">
                            </div>
                            <div class="flex items-center justify-center gap-2 text-xs text-slate-300">
                                <input type="checkbox" id="no-repeat-prize-draw" class="h-3 w-3 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <label for="no-repeat-prize-draw" data-label-key="noRepeatCheckboxLabel">N√£o repetir sorteados</label>
                            </div>
                            <button type="button" id="prize-draw-random-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold p-3 rounded-lg text-lg shadow-lg mt-1" data-label-key="prizeDrawRandomButton">Sortear</button>
                            <input type="text" id="prize-draw-number-manual" data-label-key="prizeDrawTicketNumberPlaceholder" placeholder="N¬∫ Cartela" class="text-center text-base font-bold p-2 border-2 border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 mt-2">
                            <input type="text" id="prize-draw-name" data-label-key="prizeDrawNamePlaceholder" placeholder="Nome (Opcional)" class="text-center text-base font-bold p-2 border-2 border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input type="text" id="prize-draw-description" data-label-key="prizeDrawDescriptionPlaceholder" placeholder="Brinde (Opcional)" class="text-center text-base font-bold p-2 border-2 border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <button type="submit" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-xl text-sm shadow-lg mt-1" data-label-key="registerPrizeButton">Registrar Brinde</button>
                        </form>
                    </div>
                </div>
                 <!-- 2. LEIL√ÉO (MOVIDO PARA O PAINEL CENTRAL) -->
                <section class="bg-gray-800 p-6 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-slate-300 mb-4 text-center" data-label-key="auctionTitle">Leil√£o</h2>
                    <form id="auction-form" class="space-y-3 max-w-lg mx-auto">
                        <input type="text" id="auction-item-name" placeholder="Nome do Item" class="w-full text-center text-base font-bold p-2 border-2 border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <div class="relative">
                            <input type="number" id="auction-item-current-bid" placeholder="Lance Inicial (R$)" class="w-full text-center text-base font-bold p-2 border-2 border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <div id="gavel-icon" class="absolute right-3 top-1/2 -translate-y-1/2 text-amber-400 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-gavel" viewBox="0 0 16 16"><path d="M8.625 0a.627.627 0 0 0-.442.183L6.938 1.432c-.084.084-.15.18-.202.283-.146.285-.233.61-.233.957v.013a.626.626 0 0 0 .131.393l.394.437-3.931 3.932a.625.625 0 0 0 0 .884l.043.043a.625.625 0 0 0 .884 0L8.53 4.101l.414.393a.625.625 0 0 0 .393.131h.013c.347 0 .672-.087.957-.233.103-.052.199-.118.283-.202l1.249-1.25a.627.627 0 0 0 .183-.442V1.25a.625.625 0 0 0-.625-.625h-2.5zm-2.43 3.362L4.35 1.517a.125.125 0 0 1 .088-.212h2.5a.125.125 0 0 1 .125.125v2.5a.125.125 0 0 1-.212.088L7.02 2.194l-2.828 2.828L5.38 3.834a.627.627 0 0 0-1.187-.22zM12.293.453l2.828 2.828-1.25 1.25-.414-.393a.625.625 0 0 0-.393-.131h-.013c-.347 0-.672.087-.957.233-.103-.052-.199-.118-.283-.202L11 2.828l2.02-2.02a.125.125 0 0 1 .177 0l-.884.884-3.931-3.931a.625.625 0 0 0 0-.884l-.043-.043a.625.625 0 0 0-.884 0L1.313 7.02l.414.393a.625.625 0 0 0 .393.131h.013c.347 0 .672-.087.957-.233.103-.052-.199-.118-.283-.202l1.25-1.25 2.828 2.828-1.25 1.25-.414-.393a.625.625 0 0 0-.393-.131h-.013a1.625 1.625 0 0 0-.957.233c-.103.052-.199.118-.283.202L4.01 13.98l-2.122 2.12a.625.625 0 0 0 0 .884l.043.043a.625.625 0 0 0 .884 0L4.938 15l1.25-1.25.414.393a.625.625 0 0 0 .393.131h.013c.347 0 .672-.087.957-.233.103-.052-.199-.118.283-.202L9.194 12l-2.828-2.828 1.25-1.25.414.393a.625.625 0 0 0 .393.131h.013c.347 0 .672-.087.957-.233.103-.052-.199-.118.283-.202l1.249-1.25 2.828 2.828-1.25 1.25-.414-.393a.625.625 0 0 0-.393-.131h-.013c-.347 0-.672.087-.957.233-.103-.052-.199-.118-.283-.202L9.844 9l2.828-2.828L15.5 8.999a.625.625 0 0 0 .884 0l.043-.043a.625.625 0 0 0 0-.884L13.599 5.24l.414-.393a.625.625 0 0 0 .131-.393v-.013a1.625 1.625 0 0 0-.233-.957c-.052-.103-.118-.199-.202-.283L12.48.983a.627.627 0 0 0-.187-.217z"/></svg>
                            </div>
                        </div>
                        <div class="flex items-center justify-center gap-2 pt-2">
                             <button type="button" id="add-50-bid" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-1 px-3 text-xs rounded-full">+ R$ 50</button>
                             <button type="button" id="add-100-bid" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-1 px-3 text-xs rounded-full">+ R$ 100</button>
                             <div class="flex items-center gap-1">
                                <input type="number" id="custom-bid-input" placeholder="Valor" class="w-20 text-center text-xs font-bold p-1 border-2 border-gray-600 bg-gray-700 rounded-lg">
                                <button type="button" id="add-custom-bid-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-1 px-2 text-xs rounded-full">Adicionar</button>
                             </div>
                        </div>
                        <!-- LANCE ATUAL EM DESTAQUE -->
                        <div class="text-center mt-4">
                            <p class="text-slate-400 text-lg uppercase tracking-wider">Lance Atual</p>
                            <p id="auction-current-bid-display" class="font-black text-amber-400 text-7xl sm:text-8xl transition-transform duration-200 ease-in-out" style="text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);">R$ 0</p>
                        </div>
                        <input type="text" id="auction-winner-name" placeholder="Nome do Arrematador" class="w-full text-center text-base font-bold p-2 border-2 border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-xl text-sm shadow-lg mt-1" data-label-key="sellItemButton">Vender Item</button>
                    </form>
                </section>
            </div>

            <!-- BARRA LATERAL DIREITA: APOIO, RODADAS E INSCREVA-SE -->
            <aside class="lg:col-span-1 flex flex-col gap-6">
                <!-- 1. APOIE O SEMINARISTA -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-xl flex-shrink-0">
                    <h3 class="text-base font-bold text-yellow-400 mb-2 text-center" data-label-key="supportTitle">Apoie o Seminarista ü§ù</h3>
                    <p class="text-center text-xs text-slate-400 mb-3">O programa sempre ser√° GRATUITO, gostaria de ajudar de alguma forma neste projeto?</p>
                    <button id="show-donation-modal-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all shadow-lg" data-label-key="supportButton">Fa√ßa sua Doa√ß√£o</button>
                </div>
                
                <!-- 3. RODADAS E PR√äMIOS (CONTE√öDO FLEX√çVEL) -->
                <div class="bg-gray-800 rounded-2xl shadow-xl p-6 flex-grow flex flex-col">
                        <h2 class="text-2xl font-bold text-slate-300 mb-4 flex-shrink-0" data-label-key="roundsAndPrizesTitle">Rodadas e Pr√™mios</h2>
                        <!-- A lista de jogos continua rol√°vel, mas agora ocupa a altura do pai que est√° esticado -->
                        <div id="games-list" class="space-y-3 pr-2 flex-grow overflow-y-auto"></div>
                        <!-- BOT√ÉO ADICIONAR RODADA EXTRA -->
                        <button id="add-extra-game-btn" class="w-full bg-sky-700 hover:bg-sky-800 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg transition-all mt-4 flex-shrink-0" data-label-key="addExtraRoundButton">Adicionar Rodada Extra</button>
                </div>

                <!-- 4. INSCREVA-SE NO CANAL (FIXO NO FINAL) -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-xl flex-shrink-0">
                    <div class="text-center">
                        <h3 class="text-base font-bold text-red-500 mb-3" data-label-key="subscribeTitle">Inscreva-se no Canal</h3>
                        <!-- √çcone do YouTube usando SVG inline para garantir visibilidade -->
                        <svg class="w-12 h-12 mx-auto mb-2 text-red-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19.615 3.184c-3.613-.243-11.666-.243-15.278 0C1.196 3.427.818 3.82.637 4.298c-.18.479-.18 1.488-.18 3.513v7.382c0 2.024 0 3.033.18 3.513.181.478.559.871 1.094 1.114 3.613.243 11.666.243 15.278 0 .535-.243.913-.636 1.094-1.114.18-.48.18-1.489.18-3.513V7.811c0-2.025 0-3.033-.18-3.513-.181-.478-.559-.871-1.094-1.114zM9.545 15.545V8.455L15.61 12l-6.065 3.545z"/>
                        </svg>
                        <p class="text-xs text-slate-300 mb-3">Clique para se inscrever e acompanhar as novidades do projeto!</p>
                        <a href="https://www.youtube.com/@iaecatolico" target="_blank" class="inline-block px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-sm transition-all shadow-lg" data-label-key="subscribeButton">Inscrever-se no Canal</a>
                    </div>
                </div>
            </aside>
        </main>
        <footer class="text-center py-4 px-4 text-xs text-gray-400 dark:text-gray-500">
            <p class="font-bold">Este programa √© o resultado do Trabalho de Conclus√£o de Curso de <a href="https://www.instagram.com/oalison.rodrigues" target="_blank" class="text-sky-500 dark:text-sky-400 hover:underline">Alison Fernando Rodrigues dos Santos</a>, sob orienta√ß√£o do <a href="https://www.instagram.com/danilonobresant/" target="_blank" class="text-sky-500 dark:text-sky-400 hover:underline">Prof. Pe. Dr. Danilo Nobre</a>.</p>
            <p class="mt-2">T√≠tulo: "<a href="https://drive.google.com/file/d/1ePRuNoD-4jQZLrgFIanilhur3mB4-S19/view?usp=sharing" target="_blank" class="text-sky-500 dark:text-sky-400 hover:underline">E O VERBO SE FEZ I.A.?</a> DA REFLEX√ÉO TEOL√ìGICA E COMUNICATIVA AO DESENVOLVIMENTO DE SOLU√á√ïES PASTORAIS COM INTELIG√äNCIA ARTIFICIAL".</p>
            <p class="mt-2">Desenvolvido inteiramente com a Intelig√™ncia Artificial Gemini 2.5 PRO da Google, este projeto demonstra como √© poss√≠vel criar solu√ß√µes pastorais inovadoras com criatividade e ferramentas de baixo custo ou gratuitas, mesmo sem conhecimentos pr√©vios em programa√ß√£o.</p>
            <p class="mt-4">
                Vers√£o <span id="version" contenteditable="true" class="focus:outline-none focus:ring-2 ring-gray-600 rounded-lg px-2 inline-block"></span>
                - <span id="last-updated"></span>
            </p>
            <p class="mt-2">Encontrou um erro? <a href="mailto:oalison.rodrigues@gmail.com" class="text-sky-500 dark:text-sky-400 hover:underline">Reporte aqui</a></p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="verification-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4"></div>
    <div id="floating-number-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4"></div>
    <div id="winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4"></div>
    <div id="custom-alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4"></div>
    <div id="congrats-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4"></div>
    <div id="event-break-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 p-4"></div>
    <div id="menu-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div>
    <div id="winner-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div>
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div>
    <div id="clear-round-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div>
    <div id="proof-options-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div>
    <div id="spinning-wheel-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-50 p-4 perspective-[1000px]"></div>
    <div id="reset-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div>
    <div id="drawn-prizes-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div>
    <div id="donation-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div> 
    <div id="changelog-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div>
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Vari√°veis de Estado ---
        let floatingNumberTimeout = null;
        let currentVersion = "5.9.1"; // Cor do bot√£o Encerrar Evento

        function getFormattedDateTime() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }
        const VERSION_DATE = getFormattedDateTime();
        
        // Mapeamento de letras din√¢mico
        let DYNAMIC_LETTERS = ['B', 'I', 'N', 'G', 'O'];
        let DYNAMIC_LETTERS_AJUDE = ['A', 'J', 'U', 'D', 'E'];

        const BINGO_CONFIG = { B: { min: 1, max: 15 }, I: { min: 16, max: 30 }, N: { min: 31, max: 45 }, G: { min: 46, max: 60 }, O: { min: 61, max: 75 },
                               A: { min: 1, max: 15 }, J: { min: 16, max: 30 }, U: { min: 31, max: 45 }, D: { min: 46, max: 60 }, E: { min: 61, max: 75 } };
        const LETTERS = Object.keys(BINGO_CONFIG);
        const roundColors = ['#16a34a', '#ca8a04', '#c2410c', '#0e7490', '#be185d', '#6d28d9', '#059669', '#b45309'];
        
        let gamesData = {}; 
        let activeGameNumber = null;
        let currentBingoType = ''; 
        let gameCount = 6;
        let menuItems = [ "Refrigerante - R$ 5,00", "Cerveja - R$ 7,00", "√Ågua - R$ 3,00", "Espetinho - R$ 8,00", "Pastel - R$ 6,00", "Por√ß√£o de Fritas - R$ 15,00" ];
        let menuInterval;
        const predefinedPrizes = [ { prize1: 'R$ 100,00', prize2: '', prize3: '' }, { prize1: 'R$ 100,00', prize2: 'R$ 200,00', prize3: '' }, { prize1: 'R$ 200,00', prize2: '', prize3: '' }, { prize1: 'R$ 100,00', prize2: 'R$ 300,00', prize3: '' }, { prize1: 'R$ 300,00', prize2: '', prize3: 'R$ 300,00' }, { prize1: 'R$ 200,00', prize2: 'R$ 2.000,00', prize3: '' } ];
        let confettiAnimationId;
        let spinTimeout;
        let cycloneInterval;
        let saveTimeout; // Debounce timer for saving state
        let drawnPrizeNumbers = [];
        let winnerDisplayTimeout; 
        const winnerDisplayDuration = 5000;
        let versionHistory = `**v5.9.1 (Atual)**
- **DIFERENCIA√á√ÉO VISUAL:** O bot√£o "Encerrar Evento" foi alterado para a cor roxa, distinguindo-o claramente do bot√£o vermelho "Reiniciar Evento" para evitar cliques acidentais.

**v5.9.0**
- **ATALHOS PERSONALIZ√ÅVEIS:** A aba "Atalhos" nas configura√ß√µes foi remodelada para permitir que o usu√°rio defina suas pr√≥prias combina√ß√µes de teclas para as a√ß√µes principais (Sorteio, Verificar, Limpar).
- **LEGENDA DE ATALHOS NA TELA:** Adicionada uma legenda de "Atalhos R√°pidos" na barra lateral esquerda. Ela √© atualizada dinamicamente para refletir os atalhos personalizados pelo usu√°rio.

**v5.8.0**
- **PERSIST√äNCIA DE ZOOM:** O n√≠vel de zoom aplicado no painel de "Verificando N√∫meros" agora √© salvo. Ao reabrir o painel, ele manter√° o √∫ltimo tamanho configurado.
- **HIST√ìRICO DE VERS√ïES APRIMORADO:** O hist√≥rico de vers√µes agora exibe apenas as 10 √∫ltimas atualiza√ß√µes e n√£o √© mais edit√°vel, garantindo a integridade das informa√ß√µes.
- **LISTA DE ATALHOS:** Adicionada uma nova aba de "Atalhos" no menu "Personalizar", listando os comandos de teclado dispon√≠veis para agilizar o uso.
- **AJUSTES VISUAIS:** O bot√£o "Reiniciar Evento" agora √© vermelho, para melhor indicar uma a√ß√£o destrutiva.
- **LINK ACAD√äMICO:** Adicionado o link para o Trabalho de Conclus√£o de Curso no rodap√©.

**v5.7.0**
- **LAYOUT DO VERIFICADOR APRIMORADO:** Os n√∫meros no painel de verifica√ß√£o agora s√£o compostos por letra e n√∫mero lado a lado, com espa√ßamento, garantindo que o layout se mantenha consistente mesmo com a aplica√ß√£o de zoom.
- **DATA E HORA DIN√ÇMICAS:** A data de "√öltima atualiza√ß√£o" no rodap√© agora reflete a data e hora exatas em que a aplica√ß√£o foi carregada, em vez de um valor fixo.

**v5.6.0**
- **ATALHOS DE TECLADO:** Adicionados atalhos para agilizar a opera√ß√£o: Sorteio Autom√°tico (CTRL + ENTER), Verificar N√∫meros (CTRL + Espa√ßo) e Limpar Rodada (CTRL + DELETE).
- **CONFER√äNCIA INTERATIVA MELHORADA:** No modal de "Verificando N√∫meros", a funcionalidade de clicar para marcar em verde foi mantida, e os n√∫meros foram significativamente ampliados (mais largos e altos) para visibilidade m√°xima.
- **CORES DA RODADA EM DESTAQUE:** A cor personalizada de cada rodada agora √© aplicada dinamicamente ao fundo do n√∫mero anunciado e na anima√ß√£o de sorteio autom√°tico, criando uma identidade visual consistente.

**v5.5.0**
- **ZOOM NA VERIFICA√á√ÉO:** Adicionado um controle de zoom deslizante dentro do modal de "Verificando N√∫meros", permitindo ajustar o tamanho dos n√∫meros sorteados em tempo real para melhor visualiza√ß√£o.
- **N√öMEROS MAIORES E MAIS LARGOS:** O design dos n√∫meros no modal de verifica√ß√£o foi aprimorado. Eles agora s√£o maiores e mais largos, com uma fonte mais forte, melhorando drasticamente a legibilidade.
- **LAYOUT OTIMIZADO:** O modal de verifica√ß√£o foi reestruturado para garantir que a rolagem da lista de n√∫meros funcione perfeitamente, mesmo com o zoom aplicado.

**v5.4.0**
- **VISIBILIDADE M√ÅXIMA:** Os n√∫meros no modal de verifica√ß√£o e no painel do n√∫mero anunciado foram significativamente ampliados para garantir a melhor legibilidade poss√≠vel em projetores e telas grandes.
- **CONTROLES DE ZOOM APRIMORADOS:** A l√≥gica dos controles de escala foi completamente refeita. O painel de n√∫meros agora expande a partir do topo, evitando quebras de layout, e o zoom do n√∫mero anunciado foi refinado para uma experi√™ncia mais suave e centralizada.

**v5.3.0**
- **PERSONALIZA√á√ÉO TOTAL DE TEXTOS:** Implementada a capacidade de editar todos os textos e r√≥tulos do aplicativo atrav√©s do menu "Personalizar", oferecendo controle total sobre a comunica√ß√£o do evento.
- **CONFER√äNCIA DE N√öMEROS APRIMORADA:** O modal de verifica√ß√£o agora exibe n√∫meros significativamente maiores. Al√©m disso, os n√∫meros s√£o interativos: clique para marc√°-los em verde, facilitando a confer√™ncia visual na cartela do jogador.

**v5.2.0**
- **CONFIRMA√á√ÉO PARA LIMPAR RODADA:** Adicionado um modal de confirma√ß√£o com anima√ß√£o para a a√ß√£o de "Limpar Rodada Atual", evitando cliques acidentais. Os textos do modal s√£o personaliz√°veis.
- **LAYOUT OTIMIZADO:** O bot√£o "Limpar Rodada Atual" foi movido para uma posi√ß√£o mais intuitiva abaixo do painel de n√∫meros.
- **PAINEL DE N√öMEROS COM CORES DA RODADA:** O fundo dos n√∫meros n√£o sorteados no painel agora reflete sutilmente a cor da rodada ativa, melhorando a imers√£o visual.
- **CORES NO MODAL DE SORTEIO:** O modal de an√∫ncio de n√∫mero (ao clicar no painel) agora tamb√©m utiliza a cor da rodada ativa.
- **MODAL DE VERIFICA√á√ÉO APRIMORADO:** O modal de verifica√ß√£o de n√∫meros foi ampliado e os n√∫meros internos foram redimensionados para que mais sorteados caibam na tela sem rolagem.

**v5.1.0**
- **N√öMEROS GIGANTES (PAINEL E VERIFICA√á√ÉO):** O tamanho dos n√∫meros no painel principal e no modal de verifica√ß√£o foi drasticamente aumentado para garantir m√°xima visibilidade em projetores e telas grandes.
- **DISPLAY DE LANCE DO LEIL√ÉO:** Adicionado um novo display de "Lance Atual" com n√∫meros enormes na se√ß√£o de leil√£o, facilitando o acompanhamento dos valores pela plateia em tempo real.
- **ANIMA√á√ÉO DE LEIL√ÉO APRIMORADA:** A anima√ß√£o do martelo do leil√£o foi melhorada para ser mais impactante e satisfat√≥ria, com um efeito de "batida" mais forte.`;

        // --- Configura√ß√µes Globais da Aplica√ß√£o (Persistidas no Firebase) ---
        let appConfig = {
            // FIXOS
            pixKey: '1e8e4af0-4d23-440c-9f3d-b4e527f65911',
            paypalLink: 'https://www.paypal.com/donate/?hosted_button_id=WJBLF3LV3RZRW',
            tutorialVideoLink: 'https://youtu.be/8iOOW-CR-WQ?si=Jolrp2qR38xhY5EZ', 
            // CONFIGUR√ÅVEIS
            bingoTitle: 'BINGO',
            boardColor: 'default',
            boardScale: 100,
            displayScale: 100,
            verificationPanelZoom: 100,
            drawnTextColor: '#FFFFFF',
            drawnTextStrokeColor: '#000000',
            drawnTextStrokeWidth: 2,
            isEventClosed: false,
            customLogoBase64: '',
            sponsorImagesBase64: [],
            shortcuts: {
                autoDraw: 'Control+Enter',
                verify: 'Control+Space',
                clearRound: 'Control+Delete'
            }
        };

        // Objeto para todos os textos customiz√°veis (i18n)
        let appLabels = {
            mainTitle: "Show de Pr√™mios",
            connectionIndicatorConnected: "Conectado",
            connectionIndicatorDisconnected: "Desconectado",
            howToUseTitle: "üé¨ Como Usar?",
            howToUseButton: "Em Breve!",
            versionHistoryButton: "Hist√≥rico de Vers√µes",
            customizeButton: "Personalizar",
            intervalButton: "Intervalo",
            generateProofButton: "Gerar Prova",
            endEventButton: "Encerrar Evento",
            resetEventButton: "Reiniciar Evento",
            winnersTitle: "Vencedores",
            bingoBoardTitle: "Painel de N√∫meros",
            activeRoundIndicatorDefault: "Selecione uma Rodada",
            activeRoundIndicatorLabel: "Rodada Ativa:",
            controlsPanelTitle: "Controles",
            boardScaleLabel: "Escala Painel N√∫meros (%):",
            displayScaleLabel: "Escala N√∫mero Anunciado (%):",
            manualAnnounceButton: "Anunciar Manual",
            autoDrawButton: "Sorteio Autom√°tico",
            verifyButton: "Verificar",
            clearRoundButton: "Limpar Rodada Atual",
            announcedNumberLabel: "N√∫mero Anunciado",
            lastNumbersLabel: "√öltimos 5 N√∫meros",
            prizeDrawTitle: "Sorteio de Brindes",
            checkDrawnPrizesButton: "Conferir Sorteados",
            prizeDrawFromLabel: "De:",
            prizeDrawToLabel: "At√©:",
            noRepeatCheckboxLabel: "N√£o repetir sorteados",
            prizeDrawRandomButton: "Sortear",
            prizeDrawTicketNumberPlaceholder: "N¬∫ Cartela",
            prizeDrawNamePlaceholder: "Nome (Opcional)",
            prizeDrawDescriptionPlaceholder: "Brinde (Opcional)",
            registerPrizeButton: "Registrar Brinde",
            supportTitle: "Apoie o Seminarista ü§ù",
            supportButton: "Fa√ßa sua Doa√ß√£o",
            roundsAndPrizesTitle: "Rodadas e Pr√™mios",
            addExtraRoundButton: "Adicionar Rodada Extra",
            subscribeTitle: "Inscreva-se no Canal",
            subscribeButton: "Inscrever-se no Canal",
            prize1Label: "Quina",
            prize2Label: "Cartela Cheia",
            prize3Label: "Azar√£o",
            intervalModalTitle: "Intervalo",
            intervalModalSubtitle: "Voltamos em breve!",
            verificationModalTitle: "Verificando N√∫meros",
            verificationModalBackButton: "Voltar ao App",
            auctionTitle: "Leil√£o",
            sellItemButton: "Vender Item",
            clearRoundConfirmTitle: "Confirmar Limpeza",
            clearRoundConfirmMessage: "Tem certeza que deseja limpar todos os n√∫meros sorteados da rodada atual?",
            clearRoundConfirmButton: "Limpar",
            clearRoundCancelButton: "Cancelar",
            modalBackButton: "Voltar ao App",
            winnerModalNamePlaceholder: "Nome do Ganhador",
            winnerModalRegisterButton: "Registrar Ganhador",
            alertModalTitle: "Aten√ß√£o",
            alertModalOkButton: "OK",
            congratsModalTitle: "Parab√©ns!",
            congratsModalPrizeLabel: "Ganhou:",
            congratsModalMessage: "Parab√©ns e muita sorte!",
            congratsModalCloseButton: "Fechar",
            menuEditModalTitle: "Editar Card√°pio",
            menuEditModalDescription: "Digite cada item em uma nova linha.",
            modalCancelButton: "Cancelar",
            modalSaveButton: "Salvar",
            winnerEditModalTitle: "Editar Vencedor",
            winnerEditModalNamePlaceholder: "Nome do Ganhador",
            winnerEditModalPrizePlaceholder: "Pr√™mio",
            winnerEditModalRemoveButton: "Remover",
            deleteConfirmModalTitle: "Confirmar Exclus√£o",
            deleteConfirmModalDeleteButton: "Excluir",
            proofOptionsModalTitle: "Gerar Prova",
            proofOptionsModalDescription: "Selecione quais rodadas e brindes incluir no documento.",
            proofOptionsModalGenerateButton: "Gerar Prova",
            spinningWheelSkipButton: "Pular Anima√ß√£o",
            resetConfirmModalTitle: "Aten√ß√£o!",
            resetConfirmModalMessage: "Tem certeza que deseja reiniciar todo o evento? Todos os dados de rodadas, pr√™mios e vencedores ser√£o perdidos permanentemente.",
            resetConfirmModalConfirmButton: "Sim, Reiniciar",
            drawnPrizesModalTitle: "Cartelas de Brinde J√° Sorteadas",
            modalCloseButton: "Fechar",
            donationModalTitle: "Apoio ao Projeto Seminarista",
            donationModalDescription: "Sua doa√ß√£o ajuda a manter este projeto ativo. Agradecemos imensamente!",
            donationModalPaypalLabel: "Doa√ß√£o via PayPal",
            donationModalPixLabel: "PIX (Chave Aleat√≥ria)",
            donationModalCopyButton: "Copiar Chave PIX",
            finalWinnersModalTitle: "Vencedores do Evento",
            finalWinnersModalProofButton: "Gerar Prova Final",
            finalWinnersModalSupportButton: "Apoie o Seminarista (PIX/PayPal)",
            changelogModalTitle: "Hist√≥rico de Vers√µes",
            changelogModalCurrentVersionLabel: "Vers√£o Atual:",
            settingsModalTitle: "Configura√ß√µes de Personaliza√ß√£o",
            settingsTabAppearance: "Apar√™ncia",
            settingsTabLabels: "Textos e R√≥tulos",
            settingsTabShortcuts: "Atalhos",
            quickShortcutsTitle: "Atalhos R√°pidos",
            shortcutsEditTitle: "Personalizar Atalhos",
            shortcutsEditDescription: "Clique em um campo e pressione a nova combina√ß√£o de teclas. As altera√ß√µes s√£o salvas automaticamente.",
            shortcutLabelAutoDraw: "Sorteio Autom√°tico",
            shortcutLabelVerify: "Verificar N√∫meros",
            shortcutLabelClearRound: "Limpar Rodada Atual",
            settingsLogoTitle: "Logo do Evento",
            settingsLogoDescription: "Cole o c√≥digo Base64 da sua imagem. A imagem ser√° redimensionada para caber no espa√ßo.",
            settingsLogoRemoveButton: "Remover Logo",
            settingsSponsorsTitle: "Imagens dos Patrocinadores",
            settingsSponsorsDescription: "Cole os c√≥digos Base64 das imagens dos seus patrocinadores, uma por linha. Elas aparecer√£o no slideshow do intervalo.",
            settingsBingoTitleLabel: "T√≠tulo do Grito de Vit√≥ria",
            settingsBingoTitleDescription: "Mude o 'BINGO!' para 'AJUDE!'.",
            settingsBoardColorLabel: "Cor de Fundo da Cartela",
            settingsBoardColorDescription: "Cor base dos n√∫meros n√£o sorteados.",
            settingsBoardColorResetButton: "Limpar Cor",
            settingsDrawnNumberTitle: "Apar√™ncia do N√∫mero Sorteado",
            settingsDrawnTextColorLabel: "Cor do Texto (Letra e N√∫mero)",
            settingsDrawnStrokeColorLabel: "Cor da Borda (Contorno)",
            settingsDrawnStrokeWidthLabel: "Largura da Borda",
            settingsTestDataButton: "Gerar Vencedores de Teste",
            settingsCloseSaveButton: "Fechar e Salvar"
        };


        // --- Firebase Vars ---
        let db, auth, userId, dbRef;
        let firebaseReady = false;

        // --- Seletores de Elementos ---
        const DOMElements = {
            mainTitle: document.getElementById('main-title'),
            connectionIndicator: document.getElementById('connection-indicator'),
            connectionStatusText: document.getElementById('connection-status-text'),
            version: document.getElementById('version'),
            lastUpdated: document.getElementById('last-updated'),
            startNewRoundBtn: document.getElementById('start-new-round-btn'),
            currentNumberEl: document.getElementById('current-number'),
            mainDisplayLabel: document.getElementById('main-display-label'),
            bingoBoardEl: document.getElementById('bingo-board'),
            bingoBoardWrapper: document.getElementById('bingo-board-wrapper'),
            manualInputForm: document.getElementById('manual-input-form'),
            letterInput: document.getElementById('letter-input'),
            numberInput: document.getElementById('number-input'),
            errorMessageEl: document.getElementById('error-message'),
            winnersContainer: document.getElementById('winners-container'),
            shareBtn: document.getElementById('share-btn'),
            endEventBtn: document.getElementById('end-event-btn'),
            resetEventBtn: document.getElementById('reset-event-btn'),
            intervalBtn: document.getElementById('interval-btn'),
            lastNumbersDisplay: document.getElementById('last-numbers-display'),
            gamesListEl: document.getElementById('games-list'),
            addExtraGameBtn: document.getElementById('add-extra-game-btn'),
            prizeDrawForm: document.getElementById('prize-draw-form'),
            checkDrawnPrizesBtn: document.getElementById('check-drawn-prizes-btn'),
            noRepeatPrizeDrawCheckbox: document.getElementById('no-repeat-prize-draw'),
            confettiCanvas: document.getElementById('confetti-canvas'),
            verificationModal: document.getElementById('verification-modal'),
            floatingNumberModal: document.getElementById('floating-number-modal'),
            winnerModal: document.getElementById('winner-modal'),
            customAlertModal: document.getElementById('custom-alert-modal'),
            congratsModal: document.getElementById('congrats-modal'),
            eventBreakModal: document.getElementById('event-break-modal'),
            menuEditModal: document.getElementById('menu-edit-modal'),
            winnerEditModal: document.getElementById('winner-edit-modal'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),
            clearRoundConfirmModal: document.getElementById('clear-round-confirm-modal'),
            proofOptionsModal: document.getElementById('proof-options-modal'),
            spinningWheelModal: document.getElementById('spinning-wheel-modal'),
            resetConfirmModal: document.getElementById('reset-confirm-modal'),
            drawnPrizesModal: document.getElementById('drawn-prizes-modal'),
            donationModal: document.getElementById('donation-modal'),
            showDonationModalBtn: document.getElementById('show-donation-modal-btn'),
            showChangelogBtn: document.getElementById('show-changelog-btn'),
            changelogModal: document.getElementById('changelog-modal'),
            showSettingsBtn: document.getElementById('show-settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            currentRoundDisplay: document.getElementById('current-round-display'), 
            currentNumberWrapper: document.getElementById('current-number-wrapper'),
            auctionForm: document.getElementById('auction-form'),
        };
        const confettiCtx = DOMElements.confettiCanvas.getContext('2d');

        // --- Fun√ß√µes de Template HTML ---
        function getModalTemplates() {
            return {
                verification: `<div id="verification-modal-content" class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-7xl w-full text-center flex flex-col h-[90vh]">
                                   <h2 class="text-3xl font-bold text-white mb-2 flex-shrink-0" data-label-key="verificationModalTitle">${appLabels.verificationModalTitle}</h2>
                                   <div class="my-4 max-w-sm mx-auto w-full flex-shrink-0">
                                       <label for="verification-zoom-slider" class="block text-sm font-bold text-slate-400 mb-1">Zoom dos N√∫meros</label>
                                       <input type="range" id="verification-zoom-slider" min="50" max="150" value="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                                   </div>
                                   <div class="flex-grow overflow-hidden -mx-4">
                                       <div id="verification-numbers-wrapper" class="h-full overflow-y-auto px-4">
                                           <div id="verification-numbers" class="flex flex-wrap gap-4 justify-center items-start content-start transition-transform duration-200" style="transform-origin: top center;"></div>
                                       </div>
                                   </div>
                                   <div class="flex justify-center gap-4 flex-wrap mt-6 flex-shrink-0">
                                       <button id="confirm-prize1-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded-full text-lg disabled:opacity-50 disabled:cursor-not-allowed">1: ${appLabels.prize1Label}</button>
                                       <button id="confirm-prize2-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full text-lg disabled:opacity-50 disabled:cursor-not-allowed">2: ${appLabels.prize2Label}</button>
                                       <button id="confirm-prize3-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full text-lg disabled:opacity-50 disabled:cursor-not-allowed">3: ${appLabels.prize3Label}</button>
                                       <button id="reject-bingo-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full text-lg mt-2 sm:mt-0" data-label-key="verificationModalBackButton">${appLabels.verificationModalBackButton}</button>
                                   </div>
                               </div>`,
                floatingNumber: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full text-center"><div id="floating-number-display" class="font-black text-white flex justify-center items-center gap-x-2 sm:gap-x-4 w-full h-96 mx-auto rounded-full shadow-inner my-4 animate-bounce-in" style="font-size: clamp(10rem, 30vw, 20rem); line-height: 1; text-shadow: 2px 2px 5px #000;"></div><button id="close-floating-btn" class="mt-8 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-full text-lg">${appLabels.modalBackButton}</button></div>`,
                winner: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full text-center"><h1 id="winner-title-display" class="text-7xl sm:text-8xl font-black text-amber-400" style="text-shadow: 0 0 20px #f59e0b;"></h1><div id="winner-prize-display" class="my-6"><p id="game-text-winner" class="text-2xl font-bold text-sky-400"></p><p id="prize-text-winner" class="text-3xl font-bold text-yellow-400 mt-1"></p></div><input type="text" id="winner-name-input" placeholder="${appLabels.winnerModalNamePlaceholder}" class="w-full text-center text-xl font-bold p-3 border-2 border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"><button id="register-winner-btn" class="mt-8 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-full text-lg">${appLabels.winnerModalRegisterButton}</button></div>`,
                alert: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><h2 class="text-2xl font-bold text-red-500 mb-4">${appLabels.alertModalTitle}</h2><p id="custom-alert-message" class="text-slate-300 text-lg"></p><button id="custom-alert-close-btn" class="mt-8 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full text-lg">${appLabels.alertModalOkButton}</button></div>`,
                congrats: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full text-center"><h2 class="text-5xl font-black text-yellow-400">${appLabels.congratsModalTitle}</h2><div id="congrats-winner-name" contenteditable="true" class="text-4xl font-bold text-white my-4 focus:outline-none focus:ring-2 ring-amber-500 rounded-lg px-2"></div><div id="congrats-prize-value" contenteditable="true" class="text-2xl text-slate-300 mb-6 focus:outline-none focus:ring-2 ring-amber-500 rounded-lg px-2"></div><p class="text-2xl text-sky-300 mt-4">${appLabels.congratsModalMessage}</p><button id="close-congrats-modal-btn" class="mt-8 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-full text-lg">${appLabels.congratsModalCloseButton}</button></div>`,
                eventBreak: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-4xl w-full text-center h-5/6 flex flex-col"><h2 id="event-break-title" class="text-5xl font-black text-sky-400 px-2">${appLabels.intervalModalTitle}</h2><p id="event-break-subtitle" class="text-2xl text-slate-300 mt-6 px-2">${appLabels.intervalModalSubtitle}</p><div class="flex-grow mt-6 grid grid-cols-1 gap-8 overflow-hidden"><div id="break-content-area" class="bg-gray-700 p-4 rounded-lg text-left flex flex-col"></div></div><div class="mt-8 flex justify-center gap-4"><button id="generate-proof-end-btn" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full text-lg">${appLabels.generateProofButton}</button><button id="close-break-modal-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-full text-lg">${appLabels.modalBackButton}</button></div><footer class="text-center pt-4 mt-4 border-t border-gray-700 text-xs text-gray-400"><p>Criado em 2025 por Alison Fernando Rodrigues dos Santos, com tecnologia Google Gemini 2.5 PRO no formato HTML.</p><p>Siga <a href="https://www.instagram.com/oalison.rodrigues" target="_blank" class="text-sky-400 hover:underline">@oalison.rodrigues</a> no Instagram e <a href="https://www.tiktok.com/@oalison.rodrigues" target="_blank" class="text-sky-400 hover:underline">TikTok</a></p><p id="version-modal" class="mt-2 focus:outline-none focus:ring-2 ring-gray-600 rounded-lg px-2 inline-block"></p></footer></div>`,
                menuEdit: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full"><h2 class="text-3xl font-bold text-white mb-4">${appLabels.menuEditModalTitle}</h2><p class="text-slate-400 mb-4">${appLabels.menuEditModalDescription}</p><textarea id="menu-textarea" class="w-full h-48 bg-gray-900 text-white p-2 rounded-lg focus:outline-none focus:ring-2 ring-amber-500"></textarea><div class="flex justify-end gap-4 mt-4"><button id="cancel-menu-edit-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full">${appLabels.modalCancelButton}</button><button id="save-menu-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-full">${appLabels.modalSaveButton}</button></div></div>`,
                winnerEdit: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-lg w-full"><h2 class="text-3xl font-bold text-white mb-6">${appLabels.winnerEditModalTitle}</h2><div class="space-y-4"><input type="text" id="edit-winner-name" placeholder="${appLabels.winnerEditModalNamePlaceholder}" class="w-full text-center text-xl font-bold p-3 border-2 border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"><input type="text" id="edit-winner-prize" placeholder="${appLabels.winnerEditModalPrizePlaceholder}" class="w-full text-center text-xl font-bold p-3 border-2 border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"></div><div class="flex justify-between items-center mt-8 gap-4"><button id="remove-winner-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-6 rounded-full">${appLabels.winnerEditModalRemoveButton}</button><div><button id="cancel-winner-edit-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full">${appLabels.modalCancelButton}</button><button id="save-winner-changes-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-full ml-2">${appLabels.modalSaveButton}</button></div></div></div>`,
                deleteConfirm: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><h2 class="text-2xl font-bold text-yellow-400 mb-4">${appLabels.deleteConfirmModalTitle}</h2><p id="delete-confirm-message" class="text-slate-300 text-lg mb-8"></p><div class="flex justify-center gap-4"><button id="cancel-delete-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full text-lg">${appLabels.modalCancelButton}</button><button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full text-lg">${appLabels.deleteConfirmModalDeleteButton}</button></div></div>`,
                clearRoundConfirm: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                                       <h2 class="text-2xl font-bold text-yellow-400 mb-4" data-label-key="clearRoundConfirmTitle">${appLabels.clearRoundConfirmTitle}</h2>
                                       <p class="text-slate-300 text-lg mb-8" data-label-key="clearRoundConfirmMessage">${appLabels.clearRoundConfirmMessage}</p>
                                       <div class="flex justify-center gap-4">
                                           <button id="cancel-clear-round-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full text-lg" data-label-key="clearRoundCancelButton">${appLabels.clearRoundCancelButton}</button>
                                           <button id="confirm-clear-round-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-full text-lg" data-label-key="clearRoundConfirmButton">${appLabels.clearRoundConfirmButton}</button>
                                       </div>
                                   </div>`,
                proofOptions: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-md w-full"><h2 class="text-3xl font-bold text-white mb-6">${appLabels.proofOptionsModalTitle}</h2><p class="text-slate-400 mb-4">${appLabels.proofOptionsModalDescription}</p><div id="proof-options-list" class="space-y-2 max-h-60 overflow-y-auto"></div><div class="flex justify-end gap-4 mt-6"><button id="cancel-proof-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full">${appLabels.modalCancelButton}</button><button id="generate-selected-proof-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full">${appLabels.proofOptionsModalGenerateButton}</button></div></div>`,
                spinningWheel: `<div class="w-full h-full max-w-3xl max-h-[40rem] relative flex items-center justify-center"><div id="bingo-cage" class="w-full h-full absolute spinning-cage"><div id="number-cyclone" class="absolute w-full h-full transform-gpu"></div><div class="absolute w-full h-full border-8 border-gray-500 rounded-full" style="transform: rotateY(0deg) translateZ(0px);"></div><div class="absolute w-full h-full border-8 border-gray-500 rounded-full" style="transform: rotateY(30deg) translateZ(0px);"></div><div class="absolute w-full h-full border-8 border-gray-500 rounded-full" style="transform: rotateY(60deg) translateZ(0px);"></div><div class="absolute w-full h-full border-8 border-gray-500 rounded-full" style="transform: rotateY(90deg) translateZ(0px);"></div><div class="absolute w-full h-full border-8 border-gray-500 rounded-full" style="transform: rotateY(120deg) translateZ(0px);"></div><div class="absolute w-full h-full border-8 border-gray-500 rounded-full" style="transform: rotateY(150deg) translateZ(0px);"></div></div><div id="drawn-ball-container" class="z-10 opacity-0"></div></div><div class="absolute bottom-10 flex gap-4"><button id="skip-animation-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full text-lg">${appLabels.spinningWheelSkipButton}</button><button id="close-drawn-btn" class="hidden bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-6 rounded-full text-lg">${appLabels.modalBackButton}</button></div>`,
                resetConfirm: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><h2 class="text-2xl font-bold text-red-500 mb-4">${appLabels.resetConfirmModalTitle}</h2><p class="text-slate-300 text-lg mb-8">${appLabels.resetConfirmModalMessage}</p><div class="flex justify-center gap-4"><button id="cancel-reset-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full text-lg">${appLabels.modalCancelButton}</button><button id="confirm-reset-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-6 rounded-full text-lg">${appLabels.resetConfirmModalConfirmButton}</button></div></div>`,
                drawnPrizes: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full text-center"><h2 class="text-3xl font-bold text-white">${appLabels.drawnPrizesModalTitle}</h2><p id="drawn-prizes-subtitle" class="text-xl font-bold text-yellow-400 mb-6"></p><div id="drawn-prizes-list" class="bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto flex flex-wrap gap-3 justify-center mb-6"></div><button id="close-drawn-prizes-btn" class="mt-8 bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-full text-lg">${appLabels.modalCloseButton}</button></div>`,
                donation: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><h2 class="text-3xl font-black text-amber-400 mb-6">${appLabels.donationModalTitle}</h2><p class="text-slate-300 mb-4">${appLabels.donationModalDescription}</p><div class="space-y-6 text-left"><div class="text-center border-b border-gray-700 pb-6"><p class="text-lg font-bold text-white mb-4">${appLabels.donationModalPaypalLabel}</p><div class="flex justify-center"><form action="https://www.paypal.com/donate" method="post" target="_top"><input type="hidden" name="hosted_button_id" value="FLVDNY994MNQS" /><input type="image" src="https://www.paypalobjects.com/pt_BR/BR/i/btn/btn_donateCC_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Fa√ßa doa√ß√µes com o bot√£o do PayPal" /></form></div></div><div class="pt-6"><p class="text-lg font-bold text-white mb-2">${appLabels.donationModalPixLabel}</p><div class="flex flex-col items-center"><div id="pix-key-display" contenteditable="false" class="bg-gray-700 text-white p-3 rounded-lg text-center text-sm font-mono select-all cursor-text max-w-full overflow-hidden whitespace-nowrap overflow-ellipsis"></div><button id="copy-pix-btn" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all">${appLabels.donationModalCopyButton}</button></div></div></div><button id="close-donation-btn" class="mt-8 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full text-lg">${appLabels.modalCloseButton}</button></div>`,
                finalWinners: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-4xl w-full text-center h-5/6 flex flex-col justify-between"><h2 id="end-title" class="text-5xl font-black text-yellow-400 mb-4 flex-shrink-0">${appLabels.finalWinnersModalTitle}</h2><div id="end-winner-display" class="flex-grow flex items-center justify-center p-4 min-h-[150px]"><div id="current-winner-card" class="bg-gray-700 p-8 rounded-xl shadow-2xl w-full max-w-2xl text-center transform scale-90 opacity-0 transition-all duration-500"></div></div><div class="mt-4 flex flex-col items-center gap-2 flex-shrink-0"><div class="flex justify-center gap-4 w-full max-w-md"><button id="generate-proof-final-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-8 rounded-full text-lg">${appLabels.finalWinnersModalProofButton}</button><button id="close-final-modal-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-8 rounded-full text-lg">${appLabels.modalCloseButton}</button></div><button id="donation-final-btn" class="mt-2 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all shadow-lg w-full max-w-xs">${appLabels.finalWinnersModalSupportButton}</button></div><footer class="text-center py-2 px-4 text-xs text-gray-400 dark:text-gray-500 mt-4 border-t border-gray-700 flex-shrink-0"><p>Este programa √© o resultado do Trabalho de Conclus√£o de Curso de <a href="https://www.instagram.com/oalison.rodrigues" target="_blank" class="text-sky-500 dark:text-sky-400 hover:underline">Alison Fernando Rodrigues dos Santos</a>, sob orienta√ß√£o do <a href="https://www.instagram.com/danilonobresant/" target="_blank" class="text-sky-500 dark:text-sky-400 hover:underline">Prof. Pe. Dr. Danilo Nobre</a>.</p><p class="mt-1">T√≠tulo: "<a href="https://drive.google.com/file/d/1ePRuNoD-4jQZLrgFIanilhur3mB4-S19/view?usp=sharing" target="_blank" class="text-sky-500 dark:text-sky-400 hover:underline">E O VERBO SE FEZ I.A.?</a> DA REFLEX√ÉO TEOL√ìGICA E COMUNICATIVA AO DESENVOLVIMENTO DE SOLU√á√ïES PASTORAIS COM INTELIG√äNCIA ARTIFICIAL".</p><p class="mt-1">Desenvolvido inteiramente com a Intelig√™ncia Artificial Gemini 2.5 PRO da Google.</p><p class="mt-2">Vers√£o <span id="version-footer-modal" class="focus:outline-none focus:ring-2 ring-gray-600 rounded-lg px-2 inline-block">${currentVersion}</span>- <span id="last-updated-footer-modal">${VERSION_DATE}</span></p></footer></div>`,
                changelog: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full flex flex-col h-[90vh]">
                               <h2 class="text-3xl font-black text-white mb-2 flex-shrink-0">${appLabels.changelogModalTitle}</h2>
                               <p class="text-xl font-bold text-sky-400 mb-4 flex-shrink-0">${appLabels.changelogModalCurrentVersionLabel} ${currentVersion}</p>
                               <div id="version-history-content" class="flex-grow w-full bg-gray-900 text-white p-4 rounded-lg overflow-y-auto text-sm leading-snug"></div>
                               <div class="flex justify-end gap-4 mt-4 flex-shrink-0">
                                   <button id="close-changelog-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-full">${appLabels.modalCloseButton}</button>
                               </div>
                           </div>`,
                settings: `<div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-3xl w-full">
                    <h2 class="text-3xl font-black text-amber-400 mb-4">${appLabels.settingsModalTitle}</h2>
                    
                    <div class="border-b border-gray-700 mb-4">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="tab-appearance" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-sky-500 text-sky-400">${appLabels.settingsTabAppearance}</button>
                            <button id="tab-labels" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">${appLabels.settingsTabLabels}</button>
                            <button id="tab-shortcuts" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">${appLabels.settingsTabShortcuts}</button>
                        </nav>
                    </div>

                    <div id="settings-content-container" class="max-h-[60vh] overflow-y-auto pr-4">
                        <div id="tab-content-appearance" class="space-y-6 text-left">
                           <div class="border-b border-gray-700 pb-6">
                                <label class="block text-xl font-bold text-slate-300 mb-2">${appLabels.settingsLogoTitle}</label>
                                <p class="text-xs text-slate-400 mb-4">${appLabels.settingsLogoDescription}</p>
                                <textarea id="custom-logo-input" placeholder="Cole o c√≥digo Base64 da imagem aqui..." class="w-full h-24 bg-gray-600 text-white p-2 rounded-lg font-mono text-xs"></textarea>
                                <button id="remove-custom-logo-btn" class="mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm">${appLabels.settingsLogoRemoveButton}</button>
                            </div>
                            <div class="border-b border-gray-700 pb-6">
                                <label class="block text-xl font-bold text-slate-300 mb-2">${appLabels.settingsSponsorsTitle}</label>
                                <p class="text-xs text-slate-400 mb-4">${appLabels.settingsSponsorsDescription}</p>
                                <textarea id="sponsor-images-input" placeholder="Cole os c√≥digos Base64 aqui (um por linha)..." class="w-full h-32 bg-gray-600 text-white p-2 rounded-lg font-mono text-xs"></textarea>
                            </div>
                            <div class="border-b border-gray-700 pb-6">
                                <label class="block text-xl font-bold text-slate-300 mb-2">${appLabels.settingsBingoTitleLabel}</label>
                                <p class="text-xs text-slate-400 mb-4">${appLabels.settingsBingoTitleDescription}</p>
                                <select id="bingo-title-select" class="w-full p-3 bg-gray-700 text-white rounded-lg focus:ring-sky-500 focus:border-sky-500">
                                    <option value="BINGO">BINGO!</option>
                                    <option value="AJUDE">AJUDE!</option>
                                </select>
                            </div>
                            <div class="border-b border-gray-700 pb-6">
                                <label class="block text-xl font-bold text-slate-300 mb-2">${appLabels.settingsBoardColorLabel}</label>
                                <p class="text-xs text-slate-400 mb-4">${appLabels.settingsBoardColorDescription}</p>
                                <div class="flex items-center justify-center gap-4">
                                     <input type="color" id="board-color-picker" class="w-12 h-12 p-1 border-2 border-gray-600 rounded-full cursor-pointer" value="#FFFFFF">
                                     <button id="reset-board-color-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all">${appLabels.settingsBoardColorResetButton}</button>
                                </div>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-3">${appLabels.settingsDrawnNumberTitle}</h3>
                            <div>
                                <label class="block text-sm font-bold text-slate-400 mb-1">${appLabels.settingsDrawnTextColorLabel}</label>
                                <input type="color" id="drawn-text-color-picker" class="w-12 h-12 p-1 border-2 border-gray-600 rounded-full cursor-pointer" value="#FFFFFF">
                            </div>
                             <div>
                                <label class="block text-sm font-bold text-slate-400 mb-1">${appLabels.settingsDrawnStrokeColorLabel}</label>
                                <input type="color" id="drawn-stroke-color-picker" class="w-12 h-12 p-1 border-2 border-gray-600 rounded-full cursor-pointer" value="#000000">
                            </div>
                            <div>
                                <label for="drawn-stroke-width-slider" class="block text-sm font-bold text-slate-400 mb-1">${appLabels.settingsDrawnStrokeWidthLabel} (<span id="drawn-stroke-width-value">2</span>px)</label>
                                <input type="range" id="drawn-stroke-width-slider" min="0" max="10" value="2" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                            </div>
                        </div>
                        
                        <div id="tab-content-labels" class="hidden">
                             <div id="labels-form-container" class="space-y-4 text-left grid grid-cols-1 md:grid-cols-2 gap-4">
                             </div>
                        </div>

                        <div id="tab-content-shortcuts" class="hidden space-y-6 text-left">
                            <h3 class="text-xl font-bold text-slate-300">${appLabels.shortcutsEditTitle}</h3>
                            <p class="text-sm text-slate-400">${appLabels.shortcutsEditDescription}</p>
                            <div id="shortcuts-form-container" class="space-y-4">
                                <!-- Os campos de atalho ser√£o inseridos aqui pelo JS -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between items-center">
                        <button id="generate-test-data-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all">${appLabels.settingsTestDataButton}</button>
                        <button id="close-settings-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-full text-lg">${appLabels.settingsCloseSaveButton}</button>
                    </div>
                </div>`
            };
        }

        const debouncedSave = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveStateToFirestore, 1500); 
        };
        
        function generateTestData() {
            gameCount = 6;
            gamesData = {};
            drawnPrizeNumbers = [12, 45, 101, 300]; 
            activeGameNumber = '3';

            for (let i = 1; i <= gameCount; i++) {
                gamesData[i] = {
                    prizes: {
                        prize1: predefinedPrizes[i - 1]?.prize1 || '',
                        prize2: predefinedPrizes[i - 1]?.prize2 || '',
                        prize3: predefinedPrizes[i - 1]?.prize3 || ''
                    },
                    calledNumbers: Array.from({ length: 30 }, (_, index) => (i - 1) * 5 + index + 1),
                    winners: [],
                    isComplete: false,
                    color: roundColors[(i-1) % roundColors.length],
                };
            }
            
            gamesData[1].winners.push({ id: 101, name: "Maria " + appLabels.prize1Label, prize: gamesData[1].prizes.prize1, gameNumber: '1', bingoType: 'prize1', numbers: gamesData[1].calledNumbers });
            gamesData[2].winners.push({ id: 201, name: "Jo√£o " + appLabels.prize2Label, prize: gamesData[2].prizes.prize2, gameNumber: '2', bingoType: 'prize2', numbers: gamesData[2].calledNumbers });
            gamesData[2].isComplete = true;
            gamesData[4].winners.push({ id: 401, name: "Pedro Teste", prize: gamesData[4].prizes.prize2, gameNumber: '4', bingoType: 'prize2', numbers: gamesData[4].calledNumbers });
            gamesData[4].isComplete = true;
            gamesData[5].winners.push({ id: 501, name: "Ana " + appLabels.prize3Label, prize: gamesData[5].prizes.prize3, gameNumber: '5', bingoType: 'prize3', numbers: gamesData[5].calledNumbers });
            gamesData[5].isComplete = true;
            gamesData[6].winners.push({ id: 601, name: "Final Evento", prize: gamesData[6].prizes.prize2, gameNumber: '6', bingoType: 'prize2', numbers: gamesData[6].calledNumbers });
            gamesData[6].isComplete = true;

            if (!gamesData['Brindes']) gamesData['Brindes'] = { winners: [] };
            gamesData['Brindes'].winners.push({ id: 901, name: "Carla", prize: "Ventilador", gameNumber: 'Brinde', bingoType: 'Sorteio', cartela: '12' });
            gamesData['Brindes'].winners.push({ id: 902, name: "Ronaldo", prize: "R√°dio", gameNumber: 'Brinde', bingoType: 'Sorteio', cartela: '101' });

            if (!gamesData['Leil√£o']) gamesData['Leil√£o'] = { winners: [] };
            gamesData['Leil√£o'].winners.push({ id: 1001, name: "Marcos", prize: "Bolo (Leil√£o)", gameNumber: 'Leil√£o', bingoType: 'Leil√£o', itemName: "Bolo de Chocolate", bid: "150" });
            
            appConfig.isEventClosed = false;
            activeGameNumber = '3';
            gamesData[3].calledNumbers = gamesData[3].calledNumbers.slice(0, 10);

            saveStateToFirestore().then(() => {
                showAlert("Dados de teste gerados com sucesso! O aplicativo ser√° recarregado com o novo hist√≥rico.");
                DOMElements.settingsModal.classList.add('hidden');
                window.location.reload(); 
            });
        }
        
        // --- Fun√ß√µes Auxiliares ---
        function applyLabels() {
            // Itera sobre o objeto de labels e atualiza os elementos correspondentes
            for (const key in appLabels) {
                const elements = document.querySelectorAll(`[data-label-key="${key}"]`);
                elements.forEach(el => {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = appLabels[key];
                    } else if (el.tagName === 'LABEL') {
                        // Para labels que cont√™m inputs, s√≥ muda o texto
                        const textNode = Array.from(el.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
                        if (textNode) textNode.textContent = appLabels[key];
                    }
                    else {
                        el.textContent = appLabels[key];
                    }
                });
            }
             // Casos especiais
            DOMElements.mainTitle.innerHTML = `${appLabels.mainTitle} <span id="subtitle-version" class="block text-xl sm:text-2xl text-slate-300"></span>`;
            
            // Atualiza os placeholders dos inputs de pr√™mio nas rodadas existentes
            document.querySelectorAll('.prize-input-label').forEach((label, index) => {
                label.textContent = `${appLabels['prize' + (index % 3 + 1) + 'Label']}:`;
            });
            renderUpdateInfo(); // Para re-renderizar a vers√£o no subt√≠tulo
        }

        function hexToRgba(hex, alpha = 1) {
            if (!hex || !/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) return null;
            let c = hex.substring(1).split('');
            if (c.length === 3) { c = [c[0], c[0], c[1], c[1], c[2], c[2]]; }
            c = '0x' + c.join('');
            return `rgba(${(c >> 16) & 255}, ${(c >> 8) & 255}, ${c & 255}, ${alpha})`;
        }

        function isLightColor(hex) {
            if (!hex || hex === 'default') return false; 
            const color = hex.startsWith('#') ? hex.slice(1) : hex;
            const r = parseInt(color.substring(0, 2), 16);
            const g = parseInt(color.substring(2, 4), 16);
            const b = parseInt(color.substring(4, 6), 16);
            const luma = 0.2126 * r + 0.7152 * g + 0.0722 * b; 
            return luma > 160;
        }

        function findNextGameNumber() {
            const sortedGameNumbers = Object.keys(gamesData).filter(key => !isNaN(key)).map(Number).sort((a, b) => a - b);
            for (const num of sortedGameNumbers) { if (!gamesData[num].isComplete) return num.toString(); }
            return null;
        }

        function areAllGamesComplete() {
            const gameKeys = Object.keys(gamesData).filter(key => !isNaN(key));
            if (gameKeys.length === 0) return false;
            return gameKeys.every(key => gamesData[key].isComplete);
        }

        function renderUpdateInfo() {
            const formattedDate = VERSION_DATE; 
            if (document.getElementById('version')) document.getElementById('version').innerText = currentVersion;
            const subtitle = document.getElementById('subtitle-version');
            if (subtitle) subtitle.innerText = `Vers√£o ${currentVersion}`;
            if (DOMElements.lastUpdated) DOMElements.lastUpdated.innerText = `√öltima atualiza√ß√£o: ${formattedDate}`;
        }

        async function saveStateToFirestore() {
            if (!firebaseReady || !dbRef) return;
            const versionToSave = currentVersion;

            appConfig.tutorialVideoLink = 'https://youtu.be/8iOOW-CR-WQ?si=Jolrp2qR38xhY5EZ'; 
            appConfig.paypalLink = 'https://www.paypal.com/donate/?hosted_button_id=WJBLF3LV3RZRW';
            appConfig.pixKey = '1e8e4af0-4d23-440c-9f3d-b4e527f65911';
            
            const appState = {
                gamesData: gamesData,
                gameCount: gameCount,
                activeGameNumber: activeGameNumber,
                menuItems: menuItems,
                drawnPrizeNumbers: drawnPrizeNumbers,
                mainTitleHTML: DOMElements.mainTitle.innerHTML,
                versionText: versionToSave,
                versionHistory: versionHistory,
                appConfig: appConfig,
                appLabels: appLabels, // Salva os textos customizados
            };
            try {
                await setDoc(dbRef, appState);
                renderUpdateInfo(); 

                if (areAllGamesComplete() && !appConfig.isEventClosed) { 
                    const allWinners = Object.values(gamesData).flatMap(game => game.winners).filter(w => w.bingoType !== 'Sorteio').reverse();
                    if (allWinners.length > 0) {
                        appConfig.isEventClosed = true;
                        await saveStateToFirestore();
                        setTimeout(() => startFinalWinnerSlide(allWinners), 1500); 
                    }
                }
            } catch (error) {
                console.error("Erro ao salvar dados no Firestore: ", error);
                showAlert("N√£o foi poss√≠vel salvar os dados. Verifique a conex√£o.");
            }
        }

        async function loadStateFromFirestore() {
            if (!dbRef) return;
            let forceSave = false;
            try {
                const docSnap = await getDoc(dbRef);
                if (docSnap.exists()) {
                    const appState = docSnap.data();
                    
                    gamesData = appState.gamesData || {};
                    gameCount = appState.gameCount || 6;
                    activeGameNumber = appState.activeGameNumber || null;
                    menuItems = appState.menuItems || [ "Refrigerante - R$ 5,00", "Cerveja - R$ 7,00", "√Ågua - R$ 3,00", "Espetinho - R$ 8,00", "Pastel - R$ 6,00", "Por√ß√£o de Fritas - R$ 15,00" ];
                    drawnPrizeNumbers = appState.drawnPrizeNumbers || [];
                    versionHistory = appState.versionHistory || versionHistory;
                    
                    if (appState.versionText && appState.versionText !== currentVersion) {
                        console.log(`[UPGRADE] Vers√£o local (${currentVersion}) for√ßada sobre a vers√£o salva (${appState.versionText}).`);
                        forceSave = true;
                    }
                    
                    if (appState.mainTitleHTML) DOMElements.mainTitle.innerHTML = appState.mainTitleHTML;
                    
                    // Carrega configura√ß√µes e labels
                    const loadedConfig = appState.appConfig || {};
                    appConfig = { ...appConfig, ...loadedConfig };
                    const loadedLabels = appState.appLabels || {};
                    appLabels = { ...appLabels, ...loadedLabels };

                    appConfig.tutorialVideoLink = 'https://youtu.be/8iOOW-CR-WQ?si=Jolrp2qR38xhY5EZ';
                    appConfig.paypalLink = 'https://www.paypal.com/donate/?hosted_button_id=WJBLF3LV3RZRW';
                    appConfig.pixKey = '1e8e4af0-4d23-440c-9f3d-b4e527f65911';

                } else {
                    gameCount = 6;
                    gamesData = {};
                    for (let i = 1; i <= gameCount; i++) {
                        gamesData[i] = {
                            prizes: {
                                prize1: predefinedPrizes[i - 1]?.prize1 || '',
                                prize2: predefinedPrizes[i - 1]?.prize2 || '',
                                prize3: predefinedPrizes[i - 1]?.prize3 || ''
                            },
                            calledNumbers: [],
                            winners: [],
                            isComplete: false,
                            color: roundColors[(i-1) % roundColors.length],
                        };
                    }
                    forceSave = true;
                }
            } catch (error) {
                console.error("Erro ao carregar dados do Firestore: ", error);
                showAlert("N√£o foi poss√≠vel carregar os dados salvos.");
            }
            
            applyLabels(); // Aplica os textos customizados
            renderUIFromState();
            
            if (forceSave) {
                 await saveStateToFirestore();
            }
        }

        function renderUIFromState() {
            renderCustomLogo();
            renderMasterBoard(); 
            DOMElements.gamesListEl.innerHTML = '';
            
            if (Object.keys(gamesData).length > 0) {
                const sortedGameNumbers = Object.keys(gamesData).filter(key => !isNaN(key)).sort((a, b) => parseInt(a) - parseInt(b));
                for (const gameNum of sortedGameNumbers) {
                    if (gamesData[gameNum] && typeof gamesData[gameNum] === 'object') {
                        const gameEl = createGameElement(gameNum, gamesData[gameNum].prizes);
                        DOMElements.gamesListEl.appendChild(gameEl);
                        if (gamesData[gameNum].isComplete) updateGameItemUI(gameEl, true);
                        else updateGameItemUI(gameEl, false);
                    }
                }
            }
            
            document.querySelectorAll('.game-item').forEach(el => el.classList.remove('active-round-highlight'));
            
            if (activeGameNumber && gamesData[activeGameNumber]) {
                if (gamesData[activeGameNumber].calledNumbers) {
                    gamesData[activeGameNumber].calledNumbers.forEach(num => updateMasterBoardCell(num));
                }
                loadRoundState(activeGameNumber);
                const activeGameItem = DOMElements.gamesListEl.querySelector(`.game-item[data-game-number="${activeGameNumber}"]`);
                if (activeGameItem) {
                    activeGameItem.classList.add('active-round-highlight');
                    const playBtn = activeGameItem.querySelector('.play-btn');
                    if (playBtn) playBtn.textContent = 'Jogando...';
                    activeGameItem.classList.remove('game-completed-style');
                }
            } else {
                 if (DOMElements.currentRoundDisplay) DOMElements.currentRoundDisplay.textContent = appLabels.activeRoundIndicatorDefault;
            }
            
            renderAllWinners();
            renderShortcutsLegend();
            
            if (Object.values(gamesData).some(game => game.winners && game.winners.length > 0)) {
                DOMElements.shareBtn.classList.remove('hidden');
                DOMElements.endEventBtn.classList.remove('hidden');
            }
            
            const boardZoomSlider = document.getElementById('board-zoom-slider');
            const displayZoomSlider = document.getElementById('display-zoom-slider');
            if (boardZoomSlider) boardZoomSlider.value = appConfig.boardScale;
            if (displayZoomSlider) displayZoomSlider.value = appConfig.displayScale;
            applyBoardZoom(appConfig.boardScale);
            applyDisplayZoom(appConfig.displayScale); 
            
            DOMElements.noRepeatPrizeDrawCheckbox.checked = true;
        }

        // --- Fun√ß√µes do Jogo ---

        function announceNumber(number) {
            if (!activeGameNumber) {
                showAlert("Por favor, selecione uma rodada clicando em 'Jogar' para iniciar.");
                return;
            }
            const game = gamesData[activeGameNumber];
            if (game.calledNumbers.includes(number)) {
                showError(`O n√∫mero ${number} j√° foi anunciado.`);
                return;
            }
            const letter = getLetterForNumber(number);
            if (!letter) {
                showError(`N√∫mero inv√°lido. Digite um valor entre 1 e 75.`);
                return;
            }
            DOMElements.mainDisplayLabel.textContent = appLabels.announcedNumberLabel;
            const currentNumberEl = DOMElements.currentNumberEl;
            currentNumberEl.style.cursor = 'default';
            
            const mainColor = appConfig.drawnTextColor;
            const strokeColor = appConfig.drawnTextStrokeColor;
            const strokeWidth = appConfig.drawnTextStrokeWidth;
            let strokeStyle = `${strokeWidth}px ${strokeColor}`;

            currentNumberEl.classList.remove('w-11/12', 'max-w-lg', 'py-8', 'rounded-lg', 'bg-white', 'text-purple-600', 'bg-slate-50', 'text-gray-800', 'text-white', 'text-gray-900', 'animate-custom-flash');
            currentNumberEl.classList.add('w-64', 'h-64', 'sm:w-[420px]', 'sm:h-[420px]', 'rounded-full', 'shadow-inner');
            
            const roundColor = gamesData[activeGameNumber]?.color;
            currentNumberEl.style.backgroundColor = roundColor || (appConfig.boardColor !== 'default' ? appConfig.boardColor : '#f1f5f9');
            
            currentNumberEl.style.color = mainColor;
            currentNumberEl.style.webkitTextStroke = strokeStyle; 
            currentNumberEl.style.textShadow = 'none';

            currentNumberEl.innerHTML = `<span>${letter}</span><span>${number}</span>`;
            currentNumberEl.style.visibility = 'visible';
            currentNumberEl.classList.remove('animate-bounce-in');
            void currentNumberEl.offsetWidth; 
            currentNumberEl.classList.add('animate-bounce-in');
            updateMasterBoardCell(number);
            updateLastNumbers(letter, number, true);
            DOMElements.numberInput.value = '';
            DOMElements.letterInput.value = '';
            saveStateToFirestore();
        }

        function showFloatingNumber(number) {
            if (!activeGameNumber) {
                showAlert("Por favor, selecione uma rodada clicando em 'Jogar' para iniciar.");
                return;
            }
            const game = gamesData[activeGameNumber];
            if (game.calledNumbers.includes(number)) {
                showError(`O n√∫mero ${number} j√° foi anunciado.`);
                return;
            }
            
            const roundColor = gamesData[activeGameNumber]?.color;
            const mainColor = appConfig.drawnTextColor;
            const strokeColor = appConfig.drawnTextStrokeColor;
            const strokeWidth = appConfig.drawnTextStrokeWidth;
            let strokeStyle = `${strokeWidth}px ${strokeColor}`;
            let bgColorStyle = `background-color: ${roundColor || '#0ea5e9'};`;
            
            DOMElements.floatingNumberModal.innerHTML = getModalTemplates().floatingNumber;
            const floatingNumberDisplay = document.getElementById('floating-number-display');
            const closeFloatingBtn = document.getElementById('close-floating-btn');
            const letter = getLetterForNumber(number);
            
            floatingNumberDisplay.innerHTML = `<span>${letter}</span><span>${number}</span>`;
            floatingNumberDisplay.classList.remove('bg-sky-500'); 
            floatingNumberDisplay.setAttribute('style', `font-size: clamp(10rem, 30vw, 20rem); line-height: 1; text-shadow: 2px 2px 5px #000; ${bgColorStyle}; color: ${mainColor}; -webkit-text-stroke: ${strokeStyle};`);
            
            DOMElements.floatingNumberModal.classList.remove('hidden');
            closeFloatingBtn.addEventListener('click', () => {
                DOMElements.floatingNumberModal.classList.add('hidden');
                clearTimeout(floatingNumberTimeout);
                announceNumber(number);
            });
            clearTimeout(floatingNumberTimeout);
            floatingNumberTimeout = setTimeout(() => {
                DOMElements.floatingNumberModal.classList.add('hidden');
                announceNumber(number);
            }, 5000); 
        }

        function handleAutoDraw() {
            if (!activeGameNumber) {
                showAlert("Selecione uma rodada para o sorteio autom√°tico.");
                return;
            }
            const game = gamesData[activeGameNumber];
            const allNumbers = Array.from({ length: 75 }, (_, i) => i + 1);
            const availableNumbers = allNumbers.filter(num => !game.calledNumbers.includes(num));

            if (availableNumbers.length === 0) {
                showAlert("Todos os n√∫meros j√° foram sorteados nesta rodada!");
                return;
            }
            
            document.querySelectorAll('[data-label-key="autoDrawButton"]').forEach(btn => btn.disabled = true);

            DOMElements.spinningWheelModal.innerHTML = getModalTemplates().spinningWheel;
            DOMElements.spinningWheelModal.classList.remove('hidden');

            const cycloneEl = document.getElementById('number-cyclone');
            const cageEl = document.getElementById('bingo-cage');
            const ballContainer = document.getElementById('drawn-ball-container');
            const skipBtn = document.getElementById('skip-animation-btn');
            const closeBtn = document.getElementById('close-drawn-btn');

            cycloneEl.innerHTML = '';
            const particles = Math.min(availableNumbers.length, 50);
            for (let i = 0; i < particles; i++) {
                const particle = document.createElement('div');
                particle.className = 'number-cyclone-particle text-2xl';
                particle.textContent = availableNumbers[i % availableNumbers.length];
                const anim = Math.ceil(Math.random() * 4);
                particle.style.animation = `fly-in-cage-${anim} ${3 + Math.random() * 4}s ${Math.random() * -2}s alternate infinite`;
                cycloneEl.appendChild(particle);
            }

            const finishAnimation = (drawnNumber) => {
                clearTimeout(spinTimeout);
                clearInterval(cycloneInterval);
                const letter = getLetterForNumber(drawnNumber);
                
                const finalColor = appConfig.drawnTextColor;
                const finalStroke = `${appConfig.drawnTextStrokeWidth}px ${appConfig.drawnTextStrokeColor}`;
                const roundColor = gamesData[activeGameNumber]?.color;
                const revealColor = roundColor || (appConfig.boardColor !== 'default' && appConfig.boardColor !== '#FFFFFF' ? appConfig.boardColor : '#10b981');
                
                ballContainer.innerHTML = `<div class="font-black flex justify-center items-center gap-x-2 sm:gap-x-4 w-64 h-64 sm:w-96 sm:h-96 rounded-full shadow-inner ball-fall-in" style="font-size: clamp(8rem, 40vw, 25rem); line-height: 1; background-color: ${revealColor}; color: ${finalColor}; -webkit-text-stroke: ${finalStroke}; text-shadow: none;"><span>${letter}</span><span>${drawnNumber}</span></div>`;
                
                cageEl.style.animationPlayState = 'paused';
                cageEl.style.opacity = '0.3';
                ballContainer.style.opacity = '1';
                skipBtn.style.display = 'none';
                closeBtn.style.display = 'block';

                closeBtn.onclick = () => {
                    DOMElements.spinningWheelModal.classList.add('hidden');
                    document.querySelectorAll('[data-label-key="autoDrawButton"]').forEach(btn => btn.disabled = false);
                    announceNumber(drawnNumber);
                };
            };
            
            const randomIndex = Math.floor(Math.random() * availableNumbers.length);
            const drawnNumber = availableNumbers[randomIndex];

            spinTimeout = setTimeout(() => finishAnimation(drawnNumber), 4000);
            skipBtn.onclick = () => finishAnimation(drawnNumber);
        }
        
        function cancelAnnouncedNumber(number) {
            if (!activeGameNumber) return;
            const game = gamesData[activeGameNumber];
            const numberIndex = game.calledNumbers.indexOf(number);
            if (numberIndex === -1) return;
            game.calledNumbers.splice(numberIndex, 1);
            const cell = document.getElementById(`master-cell-${number}`);
            if (cell) {
                cell.classList.remove('bg-green-500', 'text-white', 'scale-125');
                cell.style.backgroundColor = ''; // Limpa a cor inline
                const activeRoundColor = gamesData[activeGameNumber]?.color;

                if (activeRoundColor) {
                    cell.style.backgroundColor = hexToRgba(activeRoundColor, 0.25);
                    cell.classList.add('text-slate-200');
                } else if (appConfig.boardColor !== 'default') {
                    cell.style.backgroundColor = appConfig.boardColor;
                    cell.classList.add(isLightColor(appConfig.boardColor) ? 'text-gray-900' : 'text-white');
                } else {
                    cell.classList.add('bg-gray-700', 'text-slate-300');
                    cell.classList.remove('text-gray-900');
                }
            }
            DOMElements.lastNumbersDisplay.innerHTML = '';
            const lastFive = game.calledNumbers.slice(-5).reverse();
            lastFive.forEach(num => {
                const letter = getLetterForNumber(num);
                const numberEl = document.createElement('div');
                numberEl.className = 'bg-gray-700 text-slate-100 font-bold rounded-lg w-24 h-16 flex items-center justify-center text-3xl shadow-md';
                numberEl.textContent = `${letter}-${num}`;
                DOMElements.lastNumbersDisplay.appendChild(numberEl);
            });
            const lastCalledNumber = game.calledNumbers[game.calledNumbers.length - 1];
            if (lastCalledNumber) {
                const letter = getLetterForNumber(lastCalledNumber);
                const mainColor = appConfig.drawnTextColor;
                const strokeColor = appConfig.drawnTextStrokeColor;
                const strokeWidth = appConfig.drawnTextStrokeWidth;
                DOMElements.currentNumberEl.style.color = mainColor;
                DOMElements.currentNumberEl.style.webkitTextStroke = `${strokeWidth}px ${strokeColor}`;
                DOMElements.currentNumberEl.innerHTML = `<span>${letter}</span><span>${lastCalledNumber}</span>`;
                DOMElements.currentNumberEl.style.visibility = 'visible';
                DOMElements.currentNumberEl.classList.remove('animate-bounce-in');
                void DOMElements.currentNumberEl.offsetWidth; 
                DOMElements.currentNumberEl.classList.add('animate-bounce-in');
            } else {
                DOMElements.currentNumberEl.style.visibility = 'hidden';
            }
            saveStateToFirestore();
        }

        function startNewRound() {
            if (!activeGameNumber) {
                showAlert("Selecione uma rodada clicando em 'Jogar' primeiro.");
                return;
            }
            gamesData[activeGameNumber].calledNumbers = [];
            loadRoundState(activeGameNumber);
            saveStateToFirestore();
        }

        function loadRoundState(gameNumber) {
            activeGameNumber = gameNumber;
            const game = gamesData[gameNumber];
            
            if (DOMElements.currentRoundDisplay) DOMElements.currentRoundDisplay.textContent = `${appLabels.activeRoundIndicatorLabel} ${gameNumber}`;

            DOMElements.currentNumberEl.style.visibility = 'hidden';
            DOMElements.currentNumberEl.classList.remove('animate-bounce-in');
            DOMElements.errorMessageEl.textContent = '';
            DOMElements.lastNumbersDisplay.innerHTML = '';
            DOMElements.numberInput.value = '';
            DOMElements.letterInput.value = '';
            clearMasterBoard(true);
            game.calledNumbers.forEach(num => updateMasterBoardCell(num));
            const lastFive = game.calledNumbers.slice(-5).reverse();
            lastFive.forEach(num => {
                const letter = getLetterForNumber(num);
                updateLastNumbers(letter, num, false);
            });
            const lastNumber = game.calledNumbers[game.calledNumbers.length - 1];
            if (lastNumber) {
                const letter = getLetterForNumber(lastNumber);
                const mainColor = appConfig.drawnTextColor;
                const strokeColor = appConfig.drawnTextStrokeColor;
                const strokeWidth = appConfig.drawnTextStrokeWidth;
                DOMElements.currentNumberEl.style.color = mainColor;
                DOMElements.currentNumberEl.style.webkitTextStroke = `${strokeWidth}px ${strokeColor}`;

                DOMElements.currentNumberEl.innerHTML = `<span>${letter}</span><span>${lastNumber}</span>`;
                DOMElements.currentNumberEl.style.visibility = 'visible';
            }
        }

        function renderMasterBoard() {
            DOMElements.bingoBoardEl.innerHTML = '';
            const currentLetters = appConfig.bingoTitle === 'AJUDE' ? DYNAMIC_LETTERS_AJUDE : DYNAMIC_LETTERS;

            currentLetters.forEach(letter => {
                const columnWrapper = document.createElement('div');
                // Cada letra agora ocupa 2 colunas no grid principal de 10 colunas
                columnWrapper.className = 'col-span-2 flex flex-col items-center';
                
                const headerEl = document.createElement('div');
                headerEl.className = 'font-black text-4xl text-sky-400 mb-4';
                headerEl.textContent = letter;
                columnWrapper.appendChild(headerEl);

                const numbersGrid = document.createElement('div');
                numbersGrid.className = 'grid grid-cols-2 gap-2'; // Grid interno de 2 colunas para os n√∫meros

                let baseLetter = DYNAMIC_LETTERS[currentLetters.indexOf(letter)];
                const { min, max } = BINGO_CONFIG[baseLetter];

                for (let i = min; i <= max; i++) {
                    const cell = document.createElement('div');
                    cell.id = `master-cell-${i}`;
                    cell.textContent = i;
                    
                    let cellClasses = 'bingo-cell h-20 w-20 flex items-center justify-center font-black text-4xl rounded-full transition-all duration-300';
                    if (appConfig.boardColor !== 'default') {
                        cell.style.backgroundColor = appConfig.boardColor;
                        cellClasses += isLightColor(appConfig.boardColor) ? ' text-gray-900' : ' text-white';
                    } else {
                        cellClasses += ' bg-gray-700 text-slate-300';
                    }
                    cell.className = cellClasses;

                    cell.addEventListener('click', () => {
                        if (!activeGameNumber) {
                            showAlert("Por favor, selecione uma rodada clicando em 'Jogar' para iniciar.");
                            return;
                        }
                        const game = gamesData[activeGameNumber];
                        if (game.calledNumbers.includes(i)) cancelAnnouncedNumber(i);
                        else showFloatingNumber(i);
                    });
                    numbersGrid.appendChild(cell);
                }
                columnWrapper.appendChild(numbersGrid);
                DOMElements.bingoBoardEl.appendChild(columnWrapper);
            });
        }
        
        function clearMasterBoard(applyCustomColor = false) {
            const activeRoundColor = (activeGameNumber && gamesData[activeGameNumber]?.color) ? gamesData[activeGameNumber].color : null;
            for (let i = 1; i <= 75; i++) {
                const cell = document.getElementById(`master-cell-${i}`);
                if (cell) {
                    cell.classList.remove('bg-green-500', 'text-white', 'scale-125', 'text-gray-900', 'text-slate-200');
                    cell.style.backgroundColor = '';
                    cell.className = 'bingo-cell h-20 w-20 flex items-center justify-center font-black text-4xl rounded-full transition-all duration-300';

                    if (applyCustomColor && activeRoundColor) {
                        cell.style.backgroundColor = hexToRgba(activeRoundColor, 0.25); // Cor da rodada transl√∫cida
                        cell.classList.add('text-slate-200');
                    } else if (applyCustomColor && appConfig.boardColor !== 'default') {
                        cell.style.backgroundColor = appConfig.boardColor;
                        cell.classList.add(isLightColor(appConfig.boardColor) ? 'text-gray-900' : 'text-white');
                    } else {
                        cell.classList.add('bg-gray-700', 'text-slate-300');
                    }
                }
            }
        }

        function handleManualInput(event) {
            event.preventDefault();
            const numValue = DOMElements.numberInput.value;
            if (!numValue) return;
            const number = parseInt(numValue, 10);
            const letterValue = DOMElements.letterInput.value.toUpperCase();
            if (letterValue && getLetterForNumber(number) !== letterValue) {
                showError('A letra n√£o corresponde ao n√∫mero.');
                return;
            }
            announceNumber(number);
        }
        
        function updateLastNumbers(letter, number, addToState) {
            if (addToState && activeGameNumber) {
                gamesData[activeGameNumber].calledNumbers.push(number);
                gamesData[activeGameNumber].calledNumbers.sort((a, b) => a - b);
            }
            const numberEl = document.createElement('div');
            numberEl.className = 'bg-gray-700 text-slate-100 font-bold rounded-lg w-24 h-16 flex items-center justify-center text-3xl shadow-md';
            numberEl.textContent = `${letter}-${number}`;
            DOMElements.lastNumbersDisplay.prepend(numberEl);
            if (DOMElements.lastNumbersDisplay.children.length > 5) {
                DOMElements.lastNumbersDisplay.lastChild.remove();
            }
        }

        function getLetterForNumber(number) {
            for (const letter of DYNAMIC_LETTERS) {
                const baseLetter = DYNAMIC_LETTERS[DYNAMIC_LETTERS.indexOf(letter)];
                if (number >= BINGO_CONFIG[baseLetter].min && number <= BINGO_CONFIG[baseLetter].max) {
                    return appConfig.bingoTitle === 'AJUDE' ? DYNAMIC_LETTERS_AJUDE[DYNAMIC_LETTERS.indexOf(letter)] : letter;
                }
            }
            return null;
        }

        function updateMasterBoardCell(number) {
            const cell = document.getElementById(`master-cell-${number}`);
            if (cell) {
                const roundColor = gamesData[activeGameNumber]?.color;

                // Limpa todas as classes de cor de fundo e texto
                cell.classList.remove('bg-gray-700', 'text-slate-300', 'text-gray-900', 'bg-green-500', 'text-white', 'text-slate-200');
                cell.style.backgroundColor = '';

                if (roundColor) {
                    cell.style.backgroundColor = roundColor;
                    cell.classList.add(isLightColor(roundColor) ? 'text-gray-900' : 'text-white', 'scale-125');
                } else {
                    // Fallback para o verde padr√£o se n√£o houver cor de rodada
                    cell.classList.add('bg-green-500', 'text-white', 'scale-125');
                }
            }
        }

        function showError(message) {
            DOMElements.errorMessageEl.textContent = message;
            setTimeout(() => { DOMElements.errorMessageEl.textContent = ''; }, 3000);
        }

        function showAlert(message) {
            DOMElements.customAlertModal.innerHTML = getModalTemplates().alert;
            document.getElementById('custom-alert-message').textContent = message;
            DOMElements.customAlertModal.classList.remove('hidden');
            document.getElementById('custom-alert-close-btn').addEventListener('click', () => DOMElements.customAlertModal.classList.add('hidden'));
        }

        function showVerificationModal() {
            if (!activeGameNumber) {
                showAlert("Nenhuma rodada ativa para verificar.");
                return;
            }
             if (gamesData[activeGameNumber].calledNumbers.length === 0) {
                showAlert("Nenhum n√∫mero foi sorteado nesta rodada para verificar.");
                return;
            }
            const gameItem = DOMElements.gamesListEl.querySelector(`.game-item[data-game-number="${activeGameNumber}"]`);
            if(gameItem) {
                gameItem.querySelectorAll('.prize-input').forEach(input => {
                    gamesData[activeGameNumber].prizes[input.dataset.type] = input.innerText.trim();
                });
            }

            DOMElements.verificationModal.innerHTML = getModalTemplates().verification;
            const verificationNumbersContainer = document.getElementById('verification-numbers');
            const zoomSlider = document.getElementById('verification-zoom-slider');
            const confirmPrize1Btn = document.getElementById('confirm-prize1-btn');
            const confirmPrize2Btn = document.getElementById('confirm-prize2-btn');
            const confirmPrize3Btn = document.getElementById('confirm-prize3-btn');
            document.getElementById('reject-bingo-btn').addEventListener('click', handleRejectBingo);
            const prizes = gamesData[activeGameNumber].prizes;
            confirmPrize1Btn.disabled = !prizes.prize1;
            confirmPrize2Btn.disabled = !prizes.prize2;
            confirmPrize3Btn.disabled = !prizes.prize3;

            if (zoomSlider && verificationNumbersContainer) {
                // Set initial zoom from saved config
                const initialZoom = appConfig.verificationPanelZoom || 100;
                zoomSlider.value = initialZoom;
                verificationNumbersContainer.style.transform = `scale(${initialZoom / 100})`;

                // Add event listener to update and save zoom
                zoomSlider.addEventListener('input', (e) => {
                    const scale = e.target.value / 100;
                    verificationNumbersContainer.style.transform = `scale(${scale})`;
                    appConfig.verificationPanelZoom = parseInt(e.target.value, 10);
                    debouncedSave();
                });
            }
            
            gamesData[activeGameNumber].calledNumbers.forEach(n => {
                const letter = getLetterForNumber(n);
                const numberEl = document.createElement('div');
                numberEl.className = 'verification-cell bg-gray-700 text-white font-black rounded-lg w-auto px-6 h-44 flex items-center justify-center text-8xl shadow-md cursor-pointer transition-colors duration-200 gap-x-4';
                numberEl.innerHTML = `<span>${letter}</span><span>-</span><span>${n}</span>`;
                 numberEl.addEventListener('click', () => {
                    numberEl.classList.toggle('bg-green-500');
                    numberEl.classList.toggle('bg-gray-700');
                });
                verificationNumbersContainer.appendChild(numberEl);
            });
            const setupConfirmationListener = (button, type) => { button.addEventListener('click', () => { currentBingoType = type; showWinnerModal(); }); };
            setupConfirmationListener(confirmPrize1Btn, 'prize1');
            setupConfirmationListener(confirmPrize2Btn, 'prize2');
            setupConfirmationListener(confirmPrize3Btn, 'prize3');
            DOMElements.verificationModal.classList.remove('hidden');
            startConfetti();
        }
        
        function handleRejectBingo() {
            document.getElementById('verification-modal-content').classList.add('animate-shake-error');
            setTimeout(() => {
                DOMElements.verificationModal.classList.add('hidden');
            }, 800);
            stopConfetti();
        }

        function handleWinnerRegistration() {
            const winnerNameInput = document.getElementById('winner-name-input');
            stopConfetti();
            const winnerName = winnerNameInput.value.trim();
            if (!winnerName) {
                showAlert("Por favor, preencha o nome do ganhador.");
                return;
            }
            const prizeValue = gamesData[activeGameNumber].prizes[currentBingoType] || "Pr√™mio n√£o especificado";
            const originalActiveGame = activeGameNumber;
            
            gamesData[activeGameNumber].winners = gamesData[activeGameNumber].winners.filter(w => w.bingoType !== currentBingoType);
            const winnerData = {
                id: Date.now(),
                name: winnerName,
                prize: prizeValue,
                gameNumber: activeGameNumber,
                bingoType: currentBingoType,
                numbers: [...gamesData[activeGameNumber].calledNumbers]
            };
            gamesData[activeGameNumber].winners.push(winnerData);
            
            renderAllWinners();
            hideWinnerModal();
            DOMElements.shareBtn.classList.remove('hidden');
            DOMElements.endEventBtn.classList.remove('hidden');
            
            const prizes = gamesData[activeGameNumber].prizes;
            const allPrizesEmpty = !prizes.prize1 && !prizes.prize2 && !prizes.prize3;
            const prizeLabel = appLabels[currentBingoType + 'Label'];
            const prize2Label = appLabels.prize2Label;
            const prize3Label = appLabels.prize3Label;

            const isGame1Or3 = originalActiveGame === '1' || originalActiveGame === '3';
            const isJustPrize1 = !prizes.prize2 && !prizes.prize3;

            if (prizeLabel === prize2Label || prizeLabel === prize3Label || allPrizesEmpty || (isGame1Or3 && isJustPrize1)) {
                 gamesData[activeGameNumber].isComplete = true;
            }

            saveStateToFirestore();
            renderUIFromState();
            showCongratsModal(winnerName, prizeValue);
        }
        
        function updateGameItemUI(gameItem, isComplete) {
            const playBtn = gameItem.querySelector('.play-btn');
            gameItem.classList.remove('active-round-highlight', 'animate-flash-complete');

            if (isComplete) {
                gameItem.classList.add('game-completed-style'); 
                playBtn.textContent = 'Jogado';
                playBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                playBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            } else {
                gameItem.classList.remove('game-completed-style'); 
                playBtn.textContent = 'Jogar';
                playBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                playBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
            }
            
            const winners = gamesData[gameItem.dataset.gameNumber]?.winners || [];
            
            ['prize1', 'prize2', 'prize3'].forEach(type => {
                const prizeElement = gameItem.querySelector(`.prize-input[data-type="${type}"]`);
                if (prizeElement) {
                    const prizeValue = prizeElement.innerText.trim();
                    const hasWinner = winners.some(w => w.bingoType === type);
                    let iconHtml = (prizeValue && hasWinner) ? ' <span class="text-yellow-400">üèÜ</span>' : '';
                    prizeElement.innerHTML = prizeValue + iconHtml;
                }
            });
        }

        function renderAllWinners() {
            DOMElements.winnersContainer.innerHTML = '';
            const allWinners = Object.values(gamesData).flatMap(game => game.winners || []).reverse();
            allWinners.forEach(winner => renderWinnerCard(winner));
        }

        function renderWinnerCard(data) {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'winner-card bg-gray-700 p-3 rounded-lg shadow-md transition-transform hover:scale-105';
            cardWrapper.dataset.winnerId = data.id;
            
            let nameAndCardHtml, prizeHtml, detailsHtml;

            switch (data.bingoType) {
                case 'Sorteio':
                    nameAndCardHtml = `<h3 class="text-lg font-bold text-amber-400 pointer-events-none">${data.name || 'Ganhador n√£o informado'}</h3>
                                       <p class="text-slate-300 pointer-events-none"><strong>Cartela:</strong> ${data.cartela}</p>`;
                    prizeHtml = `<p class="text-slate-300 mt-1 pointer-events-none"><strong>üéÅ Brinde:</strong> ${data.prize}</p>`;
                    detailsHtml = '';
                    break;
                case 'Leil√£o':
                    nameAndCardHtml = `<h3 class="text-lg font-bold text-amber-400 pointer-events-none">${data.name || 'Arrematador'}</h3>
                                       <p class="text-slate-300 pointer-events-none"><strong>Item:</strong> ${data.itemName}</p>`;
                    prizeHtml = `<p class="text-slate-300 mt-1 pointer-events-none"><strong>üî® Lance:</strong> R$ ${data.bid}</p>`;
                    detailsHtml = '';
                    break;
                default: // Rodadas de Bingo
                    const prizeLabel = appLabels[data.bingoType + 'Label'] || data.bingoType;
                    nameAndCardHtml = `<h3 class="text-lg font-bold text-amber-400 pointer-events-none">${data.name || 'Ganhador n√£o informado'}</h3>
                                       <p class="text-slate-300 pointer-events-none"><strong>Rodada:</strong> ${data.gameNumber} (${prizeLabel})</p>`;
                    prizeHtml = `<p class="text-slate-300 mt-1 pointer-events-none"><strong>Pr√™mio:</strong> ${data.prize}</p>`;
                    detailsHtml = data.numbers ? `<details class="pointer-events-auto"><summary class="text-sm cursor-pointer text-slate-400">Ver n√∫meros (${data.numbers.length})</summary><p class="text-xs text-slate-400 break-words mt-1">${data.numbers.map(n => `<span class="font-bold">${getLetterForNumber(n)}-${n}</span>`).join(', ')}</p></details>` : '';
                    break;
            }
            
            cardWrapper.innerHTML = `${nameAndCardHtml}${prizeHtml}${detailsHtml}`;
            cardWrapper.addEventListener('click', (e) => {
                if (e.target.tagName !== 'SUMMARY' && e.target.tagName !== 'P' && e.target.tagName !== 'SPAN') {
                    showWinnerEditModal(data.id);
                }
            });
            DOMElements.winnersContainer.appendChild(cardWrapper);
        }

        function generateProofDocument(selectedKeys) {
            const proofWindow = window.open('', '_blank');
            const allWinners = Object.values(gamesData).flatMap(game => game.winners);
            const filteredWinners = allWinners.filter(winner => {
                const gameKey = winner.bingoType === 'Sorteio' ? 'Brindes' : winner.bingoType === 'Leil√£o' ? 'Leil√£o' : `${winner.gameNumber}`;
                return selectedKeys.includes(gameKey);
            });
            const now = new Date();
            const timestamp = now.toLocaleString('pt-BR', { dateStyle: 'full', timeStyle: 'medium' });
            let htmlContent = `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><title>Prova de Resultados - ${appLabels.mainTitle}</title><style>body{font-family:Arial,sans-serif;margin:2rem;font-size:14pt;}h1,h2,h3{margin:0;padding:0;}#proof-title{text-align:center;margin-bottom:1rem;}#proof-title h1{font-size:2.8rem;color:#333;}#proof-title h2{font-size:2rem;color:#555;}.timestamp{text-align:center;font-size:1.2rem;color:#666;margin-bottom:2rem;}.winner-section{border:2px solid #ccc;padding:1.5rem;margin-bottom:1.5rem;page-break-inside:avoid;border-radius:8px;}.winner-section h3{font-size:1.8rem;color:#000;margin-bottom:0.5rem;}.winner-section p{font-size:1.3rem;margin:0.2rem 0;}.numbers-list{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:1rem;}.number-ball{background-color:#eee;border:1px solid #ddd;border-radius:50%;width:45px;height:45px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem;}.signature-section{margin-top:5rem;text-align:center;page-break-inside:avoid;}.signature-line{border-bottom:2px solid #333;width:300px;margin:0 auto;}.signature-label{margin-top:0.5rem;font-size:1.2rem;}.print-btn{display:block;margin:2rem auto;padding:.8rem 2rem;font-size:1.2rem;cursor:pointer;}@media print{.no-print{display:none}}</style></head><body><div id="proof-title">${DOMElements.mainTitle.innerHTML.replace(/<span/g, '<h2').replace(/<\/span/g, '</h2>').replace(/div/g, 'h1')}</div><p class="timestamp">Documento gerado em: ${timestamp}</p><button class="no-print print-btn" onclick="window.print()">Imprimir Prova</button><button class="no-print print-btn" onclick="window.close()">Voltar ao Aplicativo</button><hr>`;
            
            filteredWinners.forEach((winner) => {
                let title, cardHtml, prizeHtml, numbersSection;
                switch(winner.bingoType) {
                    case 'Sorteio':
                        title = `üéÅ Ganhador de Brinde: ${winner.name || 'Ganhador'}`;
                        cardHtml = `<p><strong>Cartela:</strong> ${winner.cartela}</p>`;
                        prizeHtml = `<p><strong>Pr√™mio:</strong> ${winner.prize}</p>`;
                        numbersSection = '';
                        break;
                    case 'Leil√£o':
                         title = `üî® Venda em Leil√£o: ${winner.name || 'Arrematador'}`;
                        cardHtml = `<p><strong>Item:</strong> ${winner.itemName}</p>`;
                        prizeHtml = `<p><strong>Lance Final:</strong> R$ ${winner.bid}</p>`;
                        numbersSection = '';
                        break;
                    default:
                        const prizeLabel = appLabels[winner.bingoType + 'Label'] || winner.bingoType;
                        title = `üèÜ Ganhador da Rodada ${winner.gameNumber} (${prizeLabel}): ${winner.name || 'Ganhador'}`;
                        cardHtml = '';
                        prizeHtml = `<p><strong>Pr√™mio:</strong> ${winner.prize}</p>`;
                        numbersSection = winner.numbers ? `<p><strong>üî¢ N√∫meros Sorteados (${winner.numbers.length}):</strong></p><div class="numbers-list">${winner.numbers.map(n => `<span class="number-ball">${getLetterForNumber(n)}-${n}</span>`).join('')}</div>` : '';
                        break;
                }
                htmlContent += `<div class="winner-section"><h3>${title}</h3>${cardHtml}${prizeHtml}${numbersSection}</div>`;
            });

            htmlContent += `<div class="signature-section"><div class="signature-line"></div><p class="signature-label">Assinatura do Organizador</p><p>Declaro que os resultados apresentados neste documento s√£o verdadeiros e corretos.</p></div></body></html>`;
            proofWindow.document.write(htmlContent);
            proofWindow.document.close();
        }

        function showWinnerModal() {
            stopConfetti(); 
            if (!activeGameNumber) {
                showError("Selecione uma rodada clicando em 'Jogar' antes.");
                return;
            }
            DOMElements.winnerModal.innerHTML = getModalTemplates().winner;
            document.getElementById('winner-title-display').textContent = appConfig.bingoTitle + '!';
            const prizeLabel = appLabels[currentBingoType + 'Label'];
            document.getElementById('game-text-winner').textContent = `Rodada ${activeGameNumber} - ${prizeLabel}`;
            document.getElementById('prize-text-winner').textContent = gamesData[activeGameNumber].prizes[currentBingoType] || 'Pr√™mio n√£o definido';
            document.getElementById('register-winner-btn').addEventListener('click', handleWinnerRegistration);
            DOMElements.winnerModal.classList.remove('hidden');
        }

        function hideWinnerModal() {
            DOMElements.winnerModal.classList.add('hidden');
        }
        
        function showCongratsModal(winnerName, prizeValue, cartelaNumber = null) {
            DOMElements.congratsModal.innerHTML = getModalTemplates().congrats;
            document.getElementById('congrats-winner-name').innerHTML = cartelaNumber ? `Cartela: ${cartelaNumber} - ${winnerName}` : winnerName;
            document.getElementById('congrats-prize-value').innerHTML = `${appLabels.congratsModalPrizeLabel} ${prizeValue}`;
            document.getElementById('close-congrats-modal-btn').addEventListener('click', () => { DOMElements.congratsModal.classList.add('hidden'); stopConfetti(); });
            DOMElements.congratsModal.classList.remove('hidden');
            startConfetti();
            setTimeout(stopConfetti, 5000);
        }

        function createGameElement(gameNumber, prizes = {}) {
            const gameWrapper = document.createElement('div');
            const color = gamesData[gameNumber].color || '#4b5563';
            gameWrapper.className = 'game-item flex flex-col gap-2 p-3 rounded-lg';
            gameWrapper.style.backgroundColor = color;
            gameWrapper.dataset.gameNumber = gameNumber;

            const header = document.createElement('div');
            header.className = 'flex items-center justify-between w-full';
            
            const leftGroup = document.createElement('div');
            leftGroup.className = 'flex items-center gap-2';
            const colorPicker = document.createElement('input');
            colorPicker.type = 'color';
            colorPicker.value = color;
            const gameLabel = document.createElement('span');
            gameLabel.className = 'font-bold text-lg text-slate-100';
            gameLabel.textContent = `Rodada ${gameNumber}`;
            leftGroup.appendChild(colorPicker);
            leftGroup.appendChild(gameLabel);

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex items-center gap-2';
            const playBtn = document.createElement('button');
            playBtn.className = 'play-btn bg-emerald-600 hover:bg-emerald-700 text-white font-bold px-4 py-1 rounded text-sm';
            playBtn.textContent = 'Jogar';
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>`;
            deleteBtn.className = 'delete-btn bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded';
            
            buttonGroup.appendChild(playBtn);
            buttonGroup.appendChild(deleteBtn);
            header.appendChild(leftGroup);
            header.appendChild(buttonGroup);

            const prizesContainer = document.createElement('div');
            prizesContainer.className = 'w-full space-y-1 text-sm';
            const createPrizeInput = (prizeKey, value) => {
                const prizeWrapper = document.createElement('div');
                prizeWrapper.className = 'flex items-center gap-1';
                const prizeLabelEl = document.createElement('span');
                prizeLabelEl.className = 'prize-input-label text-slate-300 w-20 text-right';
                prizeLabelEl.textContent = `${appLabels[prizeKey + 'Label']}:`;
                const prizeInput = document.createElement('div');
                prizeInput.className = `prize-input flex-grow text-white bg-black bg-opacity-20 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-amber-500`;
                prizeInput.contentEditable = true;
                prizeInput.dataset.type = prizeKey;
                prizeInput.innerText = value;
                prizeInput.addEventListener('input', () => {
                    const gameNum = parseInt(gameWrapper.dataset.gameNumber, 10);
                    if (!gamesData[gameNum].prizes) gamesData[gameNum].prizes = {};
                    gamesData[gameNum].prizes[prizeInput.dataset.type] = prizeInput.innerText.trim();
                    debouncedSave();
                });
                prizeWrapper.appendChild(prizeLabelEl);
                prizeWrapper.appendChild(prizeInput);
                return prizeWrapper;
            };
            prizesContainer.appendChild(createPrizeInput('prize1', prizes.prize1 || ''));
            prizesContainer.appendChild(createPrizeInput('prize2', prizes.prize2 || ''));
            prizesContainer.appendChild(createPrizeInput('prize3', prizes.prize3 || ''));

            colorPicker.addEventListener('input', (e) => {
                const newColor = e.target.value;
                gameWrapper.style.backgroundColor = newColor;
                gamesData[gameNumber].color = newColor;
                if (activeGameNumber === gameNumber) {
                    loadRoundState(gameNumber); // Recarrega o estado para aplicar a cor no painel
                }
                debouncedSave();
            });

            playBtn.addEventListener('click', () => {
                const currentActiveGameNumber = activeGameNumber;
                document.querySelectorAll('.game-item').forEach(el => el.classList.remove('active-round-highlight'));
                document.querySelectorAll('.play-btn').forEach(btn => { if(btn.textContent === 'Jogando...') btn.textContent = 'Jogar'; });
                if (currentActiveGameNumber && currentActiveGameNumber !== gameNumber) {
                    const oldGameData = gamesData[currentActiveGameNumber];
                    const oldGameItem = DOMElements.gamesListEl.querySelector(`.game-item[data-game-number="${currentActiveGameNumber}"]`);
                    if (oldGameItem && !oldGameData.isComplete) {
                        updateGameItemUI(oldGameItem, false);
                    }
                }
                gameWrapper.classList.add('active-round-highlight');
                playBtn.textContent = 'Jogando...';
                if (gamesData[gameNumber].isComplete) {
                    updateGameItemUI(gameWrapper, false); 
                    gamesData[gameNumber].isComplete = false;
                }
                prizesContainer.querySelectorAll('.prize-input').forEach(input => {
                    gamesData[gameNumber].prizes[input.dataset.type] = input.innerText.trim();
                });
                loadRoundState(gameNumber);
                saveStateToFirestore();
            });

            deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); showDeleteConfirmModal(gameNumber); });
            gameWrapper.appendChild(header);
            gameWrapper.appendChild(prizesContainer);
            return gameWrapper;
        }
        
        function handlePrizeDraw(event) {
            event.preventDefault();
            const ticket = document.getElementById('prize-draw-number-manual').value.trim();
            let description = document.getElementById('prize-draw-description').value.trim();
            const name = document.getElementById('prize-draw-name').value.trim() || `Ganhador da Cartela ${ticket}`;
            if (!ticket) { showAlert("Por favor, preencha o n√∫mero da cartela."); return; }
            if (!description) description = "Brinde";
            const ticketNumber = parseInt(ticket, 10);

            if (drawnPrizeNumbers.includes(ticketNumber)) {
                const existingWinner = (gamesData['Brindes']?.winners || []).find(w => parseInt(w.cartela, 10) === ticketNumber);
                if (existingWinner) {
                    showAlert(`A cartela ${ticketNumber} j√° foi registrada para ${existingWinner.name}. Por favor, remova o vencedor se quiser registrar novamente.`);
                    return;
                }
            } else if (DOMElements.noRepeatPrizeDrawCheckbox.checked) {
                drawnPrizeNumbers.push(ticketNumber);
            }

            if (!gamesData['Brindes']) gamesData['Brindes'] = { winners: [] };
            gamesData['Brindes'].winners.push({ id: Date.now(), name: name, prize: description, gameNumber: 'Brinde', bingoType: 'Sorteio', cartela: ticket });
            renderAllWinners();
            DOMElements.shareBtn.classList.remove('hidden');
            DOMElements.endEventBtn.classList.remove('hidden');
            showCongratsModal(name, description, ticket);
            document.getElementById('prize-draw-number-manual').value = '';
            document.getElementById('prize-draw-description').value = '';
            document.getElementById('prize-draw-name').value = '';
            saveStateToFirestore();
        }
        
        function handleRandomPrizeDraw() {
            const min = parseInt(document.getElementById('prize-draw-min').value, 10) || 1;
            const max = parseInt(document.getElementById('prize-draw-max').value, 10) || 500;
            const allPossibleNumbers = Array.from({ length: max - min + 1 }, (_, i) => min + i);
            const availableNumbers = allPossibleNumbers.filter(num => !drawnPrizeNumbers.includes(num));

            if (DOMElements.noRepeatPrizeDrawCheckbox.checked && availableNumbers.length === 0) {
                showAlert("Todos os n√∫meros nesta faixa j√° foram sorteados.");
                return;
            }
            
            const randomNumber = DOMElements.noRepeatPrizeDrawCheckbox.checked 
                ? availableNumbers[Math.floor(Math.random() * availableNumbers.length)]
                : Math.floor(Math.random() * (max - min + 1)) + min;
            
            if (DOMElements.noRepeatPrizeDrawCheckbox.checked && !drawnPrizeNumbers.includes(randomNumber)) {
                drawnPrizeNumbers.push(randomNumber);
                saveStateToFirestore();
            }

            DOMElements.mainDisplayLabel.textContent = "Sorteando Brinde...";
            const currentNumberEl = DOMElements.currentNumberEl;
            currentNumberEl.style.visibility = 'visible';
            currentNumberEl.classList.remove('w-64', 'h-64', 'sm:w-[420px]', 'sm:h-[420px]', 'rounded-full', 'bg-slate-50', 'text-gray-800', 'text-gray-900');
            currentNumberEl.classList.add('w-11/12', 'max-w-lg', 'py-8', 'rounded-lg', 'bg-white', 'text-white');
            currentNumberEl.style.backgroundColor = '#9333ea';
            currentNumberEl.innerHTML = '';

            let intervalId = setInterval(() => {
                currentNumberEl.textContent = Math.floor(Math.random() * (max - min + 1)) + min;
            }, 50);

            setTimeout(() => {
                clearInterval(intervalId);
                DOMElements.mainDisplayLabel.textContent = "Cartela Sorteada";
                currentNumberEl.textContent = randomNumber;
                currentNumberEl.classList.remove('animate-bounce-in');
                void currentNumberEl.offsetWidth;
                currentNumberEl.classList.add('animate-bounce-in');
                currentNumberEl.style.backgroundColor = 'white';
                currentNumberEl.classList.add('text-gray-900');
                currentNumberEl.classList.remove('text-white');
                currentNumberEl.style.webkitTextStroke = 'none';
                document.getElementById('prize-draw-number-manual').value = randomNumber;
                startConfetti();
                setTimeout(stopConfetti, 4000);
            }, 3000);
        }
        
        function showWinnerEditModal(winnerId) {
            DOMElements.winnerEditModal.innerHTML = getModalTemplates().winnerEdit;
            document.getElementById('save-winner-changes-btn').addEventListener('click', () => saveWinnerChanges(winnerId));
            document.getElementById('cancel-winner-edit-btn').addEventListener('click', hideWinnerEditModal);
            document.getElementById('remove-winner-btn').addEventListener('click', () => removeWinner(winnerId));
            const winner = Object.values(gamesData).flatMap(game => game.winners).find(w => w.id === winnerId);
            if (!winner) return;
            document.getElementById('edit-winner-name').value = winner.name;
            document.getElementById('edit-winner-prize').value = winner.prize;
            DOMElements.winnerEditModal.classList.remove('hidden');
        }

        function hideWinnerEditModal() { DOMElements.winnerEditModal.classList.add('hidden'); }

        function saveWinnerChanges(winnerId) {
            const newName = document.getElementById('edit-winner-name').value.trim();
            const newPrize = document.getElementById('edit-winner-prize').value.trim();
            if (!newName || !newPrize) { showAlert("Nome e pr√™mio n√£o podem estar vazios."); return; }
            for (const gameNumber in gamesData) {
                const winnerIndex = gamesData[gameNumber].winners.findIndex(w => w.id === winnerId);
                if (winnerIndex > -1) {
                    gamesData[gameNumber].winners[winnerIndex].name = newName;
                    gamesData[gameNumber].winners[winnerIndex].prize = newPrize;
                    break;
                }
            }
            renderAllWinners();
            hideWinnerEditModal();
            saveStateToFirestore();
        }

        function removeWinner(winnerId) {
            for (const gameNumber in gamesData) {
                const winnerData = gamesData[gameNumber].winners.find(w => w.id === winnerId);
                if (winnerData && winnerData.bingoType === 'Sorteio') {
                    const ticketNumber = parseInt(winnerData.cartela, 10);
                    const index = drawnPrizeNumbers.indexOf(ticketNumber);
                    if (index > -1) drawnPrizeNumbers.splice(index, 1);
                }
                gamesData[gameNumber].winners = gamesData[gameNumber].winners.filter(w => w.id !== winnerId);
            }
            renderAllWinners();
            hideWinnerEditModal();
            saveStateToFirestore();
        }

        function showDeleteConfirmModal(gameNumber) {
            DOMElements.deleteConfirmModal.innerHTML = getModalTemplates().deleteConfirm;
            document.getElementById('delete-confirm-message').textContent = `Tem certeza que deseja excluir a Rodada ${gameNumber}? Esta a√ß√£o n√£o pode ser desfeita.`;
            document.getElementById('confirm-delete-btn').onclick = () => handleDeleteRound(gameNumber);
            document.getElementById('cancel-delete-btn').onclick = () => DOMElements.deleteConfirmModal.classList.add('hidden');
            DOMElements.deleteConfirmModal.classList.remove('hidden');
        }
        
        function showClearRoundConfirmModal() {
            if (!activeGameNumber) {
                showAlert("Nenhuma rodada ativa para limpar.");
                return;
            }
            DOMElements.clearRoundConfirmModal.innerHTML = getModalTemplates().clearRoundConfirm;
            DOMElements.clearRoundConfirmModal.classList.remove('hidden');
            document.getElementById('confirm-clear-round-btn').addEventListener('click', () => {
                startNewRound();
                DOMElements.clearRoundConfirmModal.classList.add('hidden');
            });
            document.getElementById('cancel-clear-round-btn').addEventListener('click', () => {
                DOMElements.clearRoundConfirmModal.classList.add('hidden');
            });
        }

        function handleDeleteRound(gameNumberToDelete) {
            if (activeGameNumber === gameNumberToDelete) {
                activeGameNumber = null;
                DOMElements.currentNumberEl.style.visibility = 'hidden';
                DOMElements.lastNumbersDisplay.innerHTML = '';
                clearMasterBoard(true);
                if (DOMElements.currentRoundDisplay) DOMElements.currentRoundDisplay.textContent = appLabels.activeRoundIndicatorDefault;
            }
            delete gamesData[gameNumberToDelete];
            const gameItem = DOMElements.gamesListEl.querySelector(`.game-item[data-game-number="${gameNumberToDelete}"]`);
            if (gameItem) gameItem.remove();
            DOMElements.deleteConfirmModal.classList.add('hidden');
            saveStateToFirestore();
        }

        function showProofOptionsModal() {
            DOMElements.proofOptionsModal.innerHTML = getModalTemplates().proofOptions;
            const optionsList = document.getElementById('proof-options-list');
            optionsList.innerHTML = '';
            const gameKeys = Object.keys(gamesData).filter(key => gamesData[key].winners && gamesData[key].winners.length > 0);
            if(gameKeys.length === 0){ showAlert("Nenhum vencedor foi registrado ainda para gerar uma prova."); return; }
            
            const keyOrder = ['Leil√£o', 'Brindes', ...Object.keys(gamesData).filter(k => !isNaN(k)).sort((a, b) => a - b)];

            keyOrder.forEach(key => {
                if (gameKeys.includes(key)) {
                    let labelText;
                    if(key === 'Brindes') labelText = 'Sorteio de Brindes';
                    else if (key === 'Leil√£o') labelText = 'Itens de Leil√£o';
                    else labelText = `Rodada ${key}`;
                    optionsList.innerHTML += `<div class="flex items-center"><input id="proof-${key}" type="checkbox" value="${key}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked><label for="proof-${key}" class="ml-3 block text-sm font-medium text-slate-300">${labelText}</label></div>`;
                }
            });

            document.getElementById('generate-selected-proof-btn').addEventListener('click', () => {
                const selectedKeys = Array.from(optionsList.querySelectorAll('input:checked')).map(cb => cb.value);
                generateProofDocument(selectedKeys);
                DOMElements.proofOptionsModal.classList.add('hidden');
            });
            document.getElementById('cancel-proof-btn').addEventListener('click', () => DOMElements.proofOptionsModal.classList.add('hidden'));
            DOMElements.proofOptionsModal.classList.remove('hidden');
        }
        
        function removeDrawnPrizeNumber(numberToRemove) {
            const index = drawnPrizeNumbers.indexOf(numberToRemove);
            if (index > -1) {
                drawnPrizeNumbers.splice(index, 1);
                if (gamesData['Brindes']) {
                     gamesData['Brindes'].winners = gamesData['Brindes'].winners.filter(w => parseInt(w.cartela, 10) !== numberToRemove);
                }
                renderAllWinners();
                saveStateToFirestore();
                showAlert(`Cartela ${numberToRemove} removida da lista de sorteados. Ela pode ser sorteada novamente.`);
            }
            showDrawnPrizesModal();
        }

         function showDrawnPrizesModal() {
            DOMElements.drawnPrizesModal.innerHTML = getModalTemplates().drawnPrizes;
            const listEl = document.getElementById('drawn-prizes-list');
            const sortedDrawnNumbers = [...drawnPrizeNumbers].sort((a, b) => a - b);
            document.getElementById('drawn-prizes-subtitle').textContent = `Total de ${sortedDrawnNumbers.length} Cartelas √önicas Sorteadas`;
            if (sortedDrawnNumbers.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500">Nenhuma cartela de brinde foi sorteada ainda.</p>';
            } else {
                sortedDrawnNumbers.forEach(number => {
                    listEl.innerHTML += `<div class="bg-purple-600 text-white font-bold rounded-full w-20 h-20 flex flex-col items-center justify-center text-xl shadow-md transition-all duration-300 transform hover:scale-110 relative group"><span class="text-3xl">${number}</span><button class="absolute top-0 right-0 p-1 bg-red-700 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" onclick="removeDrawnPrizeNumber(${number});"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div>`;
                });
            }
            document.getElementById('close-drawn-prizes-btn').addEventListener('click', () => DOMElements.drawnPrizesModal.classList.add('hidden'));
            DOMElements.drawnPrizesModal.classList.remove('hidden');
        }
        window.removeDrawnPrizeNumber = removeDrawnPrizeNumber;

        function showDonationModal() {
            DOMElements.donationModal.innerHTML = getModalTemplates().donation;
            document.getElementById('pix-key-display').textContent = appConfig.pixKey;
            document.getElementById('copy-pix-btn').addEventListener('click', () => {
                 try {
                    navigator.clipboard.writeText(appConfig.pixKey).then(() => {
                        showAlert("Chave PIX copiada para a √°rea de transfer√™ncia!");
                    });
                } catch (err) {
                    showAlert("N√£o foi poss√≠vel copiar automaticamente. Por favor, selecione e copie a chave PIX manualmente.");
                }
            });
            document.getElementById('close-donation-btn').addEventListener('click', () => DOMElements.donationModal.classList.add('hidden'));
            DOMElements.donationModal.classList.remove('hidden');
        }

        function showChangelogModal() {
            DOMElements.changelogModal.innerHTML = getModalTemplates().changelog;
            const contentEl = document.getElementById('version-history-content');
            
            const versions = versionHistory.split('**v').slice(1);
            const last10Versions = versions.slice(0, 10);

            let html = '';
            last10Versions.forEach(versionBlock => {
                const lines = versionBlock.trim().split('\n');
                const titleLine = lines.shift(); 
                const title = titleLine.replace(/\*\*|\(.*\)/g, '').trim();
                const status = (titleLine.match(/\((.*)\)/) || [])[1] || '';

                html += `<div class="mb-4"><strong class="text-sky-400">v${title}</strong> ${status ? `<span class="text-xs bg-sky-500 text-white font-bold px-2 py-1 rounded-full">${status}</span>` : ''}<ul class="list-disc pl-6 mt-1 space-y-1">`;
                lines.forEach(line => {
                    if (line.trim().startsWith('-')) {
                        let cleanLine = line.trim().substring(1).trim();
                        cleanLine = cleanLine.replace(/(\w+?):/g, '<strong class="text-amber-400">$1:</strong>');
                        html += `<li class="text-slate-300">${cleanLine}</li>`;
                    }
                });
                html += `</ul></div>`;
            });
            contentEl.innerHTML = html;

            document.getElementById('close-changelog-btn').addEventListener('click', () => DOMElements.changelogModal.classList.add('hidden'));
            DOMElements.changelogModal.classList.remove('hidden');
        }

        function renderShortcutsLegend() {
            const legendList = document.getElementById('shortcuts-legend-list');
            if (!legendList) return;
            
            const shortcuts = appConfig.shortcuts;
            const labels = {
                autoDraw: appLabels.shortcutLabelAutoDraw,
                verify: appLabels.shortcutLabelVerify,
                clearRound: appLabels.shortcutLabelClearRound
            };

            legendList.innerHTML = '';
            for (const key in shortcuts) {
                const li = document.createElement('li');
                const keysHtml = shortcuts[key].split('+').map(k => `<kbd class="font-mono bg-gray-900 px-2 py-1 rounded text-amber-400">${k}</kbd>`).join(' + ');
                li.innerHTML = `${labels[key]}: ${keysHtml}`;
                legendList.appendChild(li);
            }
        }
        
        function eventToShortcutString(event) {
            if (['Control', 'Alt', 'Shift', 'Meta'].includes(event.key)) return null;

            let keyString = "";
            if (event.ctrlKey) keyString += "Control+";
            if (event.altKey) keyString += "Alt+";
            if (event.shiftKey) keyString += "Shift+";

            if (event.code === 'Space') {
                keyString += 'Space';
            } else {
                keyString += event.key.length === 1 ? event.key.toUpperCase() : event.key;
            }
            return keyString;
        }

        function showSettingsModal() {
            DOMElements.settingsModal.innerHTML = getModalTemplates().settings;

            const tabAppearance = document.getElementById('tab-appearance');
            const tabLabels = document.getElementById('tab-labels');
            const tabShortcuts = document.getElementById('tab-shortcuts');
            const contentAppearance = document.getElementById('tab-content-appearance');
            const contentLabels = document.getElementById('tab-content-labels');
            const contentShortcuts = document.getElementById('tab-content-shortcuts');
            
            const customLogoInput = document.getElementById('custom-logo-input');
            const removeCustomLogoBtn = document.getElementById('remove-custom-logo-btn');
            const sponsorImagesInput = document.getElementById('sponsor-images-input');
            const titleSelect = document.getElementById('bingo-title-select');
            const colorPicker = document.getElementById('board-color-picker');
            const resetColorBtn = document.getElementById('reset-board-color-btn');
            const drawnTextColorPicker = document.getElementById('drawn-text-color-picker');
            const drawnStrokeColorPicker = document.getElementById('drawn-stroke-color-picker');
            const drawnStrokeWidthSlider = document.getElementById('drawn-stroke-width-slider');
            const drawnStrokeWidthValue = document.getElementById('drawn-stroke-width-value');
            
            const labelsFormContainer = document.getElementById('labels-form-container');
            labelsFormContainer.innerHTML = '';
            const labelOrder = ["mainTitle", "roundsAndPrizesTitle", "winnersTitle", "bingoBoardTitle", "prizeDrawTitle", "auctionTitle", "prize1Label", "prize2Label", "prize3Label", "intervalModalTitle", "intervalModalSubtitle", "announcedNumberLabel", "lastNumbersLabel", "controlsPanelTitle", "boardScaleLabel", "displayScaleLabel", "manualAnnounceButton", "autoDrawButton", "verifyButton", "clearRoundButton", "clearRoundConfirmTitle", "clearRoundConfirmMessage", "clearRoundConfirmButton", "clearRoundCancelButton", "checkDrawnPrizesButton", "prizeDrawRandomButton", "registerPrizeButton", "sellItemButton", "addExtraRoundButton", "supportTitle", "supportButton", "howToUseTitle", "versionHistoryButton", "customizeButton", "intervalButton", "generateProofButton", "endEventButton", "resetEventButton", "subscribeTitle", "subscribeButton", "verificationModalTitle", "verificationModalBackButton", "modalBackButton", "winnerModalNamePlaceholder", "winnerModalRegisterButton", "alertModalTitle", "alertModalOkButton", "congratsModalTitle", "congratsModalPrizeLabel", "congratsModalMessage", "congratsModalCloseButton", "menuEditModalTitle", "menuEditModalDescription", "modalCancelButton", "modalSaveButton", "winnerEditModalTitle", "winnerEditModalNamePlaceholder", "winnerEditModalPrizePlaceholder", "winnerEditModalRemoveButton", "deleteConfirmModalTitle", "deleteConfirmModalDeleteButton", "proofOptionsModalTitle", "proofOptionsModalDescription", "proofOptionsModalGenerateButton", "spinningWheelSkipButton", "resetConfirmModalTitle", "resetConfirmModalMessage", "resetConfirmModalConfirmButton", "drawnPrizesModalTitle", "modalCloseButton", "donationModalTitle", "donationModalDescription", "donationModalPaypalLabel", "donationModalPixLabel", "donationModalCopyButton", "finalWinnersModalTitle", "finalWinnersModalProofButton", "finalWinnersModalSupportButton", "changelogModalTitle", "changelogModalCurrentVersionLabel", "settingsModalTitle", "settingsTabAppearance", "settingsTabLabels", "settingsTabShortcuts", "quickShortcutsTitle", "shortcutsEditTitle", "shortcutsEditDescription", "shortcutLabelAutoDraw", "shortcutLabelVerify", "shortcutLabelClearRound", "settingsLogoTitle", "settingsLogoDescription", "settingsLogoRemoveButton", "settingsSponsorsTitle", "settingsSponsorsDescription", "settingsBingoTitleLabel", "settingsBingoTitleDescription", "settingsBoardColorLabel", "settingsBoardColorDescription", "settingsBoardColorResetButton", "settingsDrawnNumberTitle", "settingsDrawnTextColorLabel", "settingsDrawnStrokeColorLabel", "settingsDrawnStrokeWidthLabel", "settingsTestDataButton", "settingsCloseSaveButton"];

            const labelDescriptions = { mainTitle: "T√≠tulo Principal do Evento", roundsAndPrizesTitle: "T√≠tulo: Rodadas e Pr√™mios", winnersTitle: "T√≠tulo: Vencedores", bingoBoardTitle: "T√≠tulo: Painel de N√∫meros", prizeDrawTitle: "T√≠tulo: Sorteio de Brindes", auctionTitle: "T√≠tulo: Leil√£o", prize1Label: "Nome do Pr√™mio 1 (Ex: Quina)", prize2Label: "Nome do Pr√™mio 2 (Ex: Cartela Cheia)", prize3Label: "Nome do Pr√™mio 3 (Ex: Azar√£o)", intervalModalTitle: "Modal Intervalo: T√≠tulo", intervalModalSubtitle: "Modal Intervalo: Subt√≠tulo", announcedNumberLabel: "R√≥tulo: N√∫mero Anunciado", lastNumbersLabel: "R√≥tulo: √öltimos 5 N√∫meros", controlsPanelTitle: "T√≠tulo: Controles", boardScaleLabel: "R√≥tulo: Escala Painel", displayScaleLabel: "R√≥tulo: Escala N√∫mero Anunciado", manualAnnounceButton: "Bot√£o: Anunciar Manual", autoDrawButton: "Bot√£o: Sorteio Autom√°tico", verifyButton: "Bot√£o: Verificar", clearRoundButton: "Bot√£o: Limpar Rodada", clearRoundConfirmTitle: "Modal Limpar: T√≠tulo", clearRoundConfirmMessage: "Modal Limpar: Mensagem", clearRoundConfirmButton: "Modal Limpar: Bot√£o Confirmar", clearRoundCancelButton: "Modal Limpar: Bot√£o Cancelar", checkDrawnPrizesButton: "Bot√£o: Conferir Sorteados", prizeDrawRandomButton: "Bot√£o: Sortear Brinde", registerPrizeButton: "Bot√£o: Registrar Brinde", sellItemButton: "Bot√£o: Vender Item", addExtraRoundButton: "Bot√£o: Adicionar Rodada", supportTitle: "T√≠tulo: Apoio", supportButton: "Bot√£o: Apoiar/Doar", howToUseTitle: "T√≠tulo: Como Usar", versionHistoryButton: "Bot√£o: Hist√≥rico de Vers√µes", customizeButton: "Bot√£o: Personalizar", intervalButton: "Bot√£o: Intervalo", generateProofButton: "Bot√£o: Gerar Prova", endEventButton: "Bot√£o: Encerrar Evento", resetEventButton: "Bot√£o: Reiniciar Evento", subscribeTitle: "T√≠tulo: Inscrever-se", subscribeButton: "Bot√£o: Inscrever-se", verificationModalTitle: "Modal Verificar: T√≠tulo", verificationModalBackButton: "Modal Verificar: Bot√£o Voltar", modalBackButton: "Bot√£o Gen√©rico: Voltar ao App", winnerModalNamePlaceholder: "Modal Vencedor: Placeholder Nome", winnerModalRegisterButton: "Modal Vencedor: Bot√£o Registrar", alertModalTitle: "Modal Alerta: T√≠tulo", alertModalOkButton: "Modal Alerta: Bot√£o OK", congratsModalTitle: "Modal Parab√©ns: T√≠tulo", congratsModalPrizeLabel: "Modal Parab√©ns: R√≥tulo Pr√™mio", congratsModalMessage: "Modal Parab√©ns: Mensagem", congratsModalCloseButton: "Modal Parab√©ns: Bot√£o Fechar", menuEditModalTitle: "Modal Editar Menu: T√≠tulo", menuEditModalDescription: "Modal Editar Menu: Descri√ß√£o", modalCancelButton: "Bot√£o Gen√©rico: Cancelar", modalSaveButton: "Bot√£o Gen√©rico: Salvar", winnerEditModalTitle: "Modal Editar Ganhador: T√≠tulo", winnerEditModalNamePlaceholder: "Modal Editar Ganhador: Placeholder Nome", winnerEditModalPrizePlaceholder: "Modal Editar Ganhador: Placeholder Pr√™mio", winnerEditModalRemoveButton: "Modal Editar Ganhador: Bot√£o Remover", deleteConfirmModalTitle: "Modal Deletar: T√≠tulo", deleteConfirmModalDeleteButton: "Modal Deletar: Bot√£o Excluir", proofOptionsModalTitle: "Modal Prova: T√≠tulo", proofOptionsModalDescription: "Modal Prova: Descri√ß√£o", proofOptionsModalGenerateButton: "Modal Prova: Bot√£o Gerar", spinningWheelSkipButton: "Anima√ß√£o: Bot√£o Pular", resetConfirmModalTitle: "Modal Resetar: T√≠tulo", resetConfirmModalMessage: "Modal Resetar: Mensagem", resetConfirmModalConfirmButton: "Modal Resetar: Bot√£o Confirmar", drawnPrizesModalTitle: "Modal Brindes Sorteados: T√≠tulo", modalCloseButton: "Bot√£o Gen√©rico: Fechar", donationModalTitle: "Modal Doa√ß√£o: T√≠tulo", donationModalDescription: "Modal Doa√ß√£o: Descri√ß√£o", donationModalPaypalLabel: "Modal Doa√ß√£o: R√≥tulo PayPal", donationModalPixLabel: "Modal Doa√ß√£o: R√≥tulo PIX", donationModalCopyButton: "Modal Doa√ß√£o: Bot√£o Copiar", finalWinnersModalTitle: "Modal Final: T√≠tulo", finalWinnersModalProofButton: "Modal Final: Bot√£o Prova", finalWinnersModalSupportButton: "Modal Final: Bot√£o Apoiar", changelogModalTitle: "Modal Vers√µes: T√≠tulo", changelogModalCurrentVersionLabel: "Modal Vers√µes: R√≥tulo Vers√£o", settingsModalTitle: "Modal Config: T√≠tulo", settingsTabAppearance: "Modal Config: Aba Apar√™ncia", settingsTabLabels: "Modal Config: Aba Textos", settingsTabShortcuts: "Modal Config: Aba Atalhos", quickShortcutsTitle: "Legenda Atalhos: T√≠tulo", shortcutsEditTitle: "Config Atalhos: T√≠tulo", shortcutsEditDescription: "Config Atalhos: Descri√ß√£o", shortcutLabelAutoDraw: "Config Atalhos: R√≥tulo Sorteio", shortcutLabelVerify: "Config Atalhos: R√≥tulo Verificar", shortcutLabelClearRound: "Config Atalhos: R√≥tulo Limpar", settingsLogoTitle: "Config Aba Apar√™ncia: T√≠tulo Logo", settingsLogoDescription: "Config Aba Apar√™ncia: Descri√ß√£o Logo", settingsLogoRemoveButton: "Config Aba Apar√™ncia: Bot√£o Remover Logo", settingsSponsorsTitle: "Config Aba Apar√™ncia: T√≠tulo Patrocinadores", settingsSponsorsDescription: "Config Aba Apar√™ncia: Descri√ß√£o Patrocinadores", settingsBingoTitleLabel: "Config Aba Apar√™ncia: T√≠tulo Grito", settingsBingoTitleDescription: "Config Aba Apar√™ncia: Descri√ß√£o Grito", settingsBoardColorLabel: "Config Aba Apar√™ncia: T√≠tulo Cor Cartela", settingsBoardColorDescription: "Config Aba Apar√™ncia: Descri√ß√£o Cor Cartela", settingsBoardColorResetButton: "Config Aba Apar√™ncia: Bot√£o Limpar Cor", settingsDrawnNumberTitle: "Config Aba Apar√™ncia: T√≠tulo Num. Sorteado", settingsDrawnTextColorLabel: "Config Aba Apar√™ncia: R√≥tulo Cor Texto", settingsDrawnStrokeColorLabel: "Config Aba Apar√™ncia: R√≥tulo Cor Borda", settingsDrawnStrokeWidthLabel: "Config Aba Apar√™ncia: R√≥tulo Largura Borda", settingsTestDataButton: "Config Bot√£o: Gerar Teste", settingsCloseSaveButton: "Config Bot√£o: Fechar e Salvar"};

            labelOrder.forEach(key => {
                 if (appLabels[key] !== undefined) {
                    const labelText = labelDescriptions[key] || key;
                    const div = document.createElement('div');
                    div.innerHTML = `<label for="label-input-${key}" class="block text-sm font-bold text-slate-400 mb-1">${labelText}</label>
                                     <input type="text" id="label-input-${key}" data-label-key-input="${key}" value="${appLabels[key]}" class="w-full p-2 bg-gray-600 text-white rounded-lg focus:ring-sky-500 border border-gray-500">`;
                    labelsFormContainer.appendChild(div);
                }
            });

            const shortcutsFormContainer = document.getElementById('shortcuts-form-container');
            shortcutsFormContainer.innerHTML = '';
            const shortcutLabels = {
                autoDraw: appLabels.shortcutLabelAutoDraw,
                verify: appLabels.shortcutLabelVerify,
                clearRound: appLabels.shortcutLabelClearRound
            };
            for (const key in appConfig.shortcuts) {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-3 items-center gap-4';
                const label = document.createElement('label');
                label.htmlFor = `shortcut-input-${key}`;
                label.className = 'text-slate-300 col-span-1';
                label.textContent = shortcutLabels[key];
                
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `shortcut-input-${key}`;
                input.readOnly = true;
                input.value = appConfig.shortcuts[key];
                input.className = 'col-span-2 p-2 bg-gray-600 text-white rounded-lg font-mono text-center cursor-pointer focus:ring-sky-500 border border-gray-500';
                
                input.addEventListener('keydown', (e) => {
                    e.preventDefault();
                    const newShortcut = eventToShortcutString(e);
                    if (newShortcut) {
                        input.value = newShortcut;
                        appConfig.shortcuts[key] = newShortcut;
                        renderShortcutsLegend();
                        debouncedSave();
                    }
                });

                div.appendChild(label);
                div.appendChild(input);
                shortcutsFormContainer.appendChild(div);
            }

            customLogoInput.value = appConfig.customLogoBase64;
            sponsorImagesInput.value = appConfig.sponsorImagesBase64.join('\n');
            titleSelect.value = appConfig.bingoTitle;
            colorPicker.value = appConfig.boardColor === 'default' ? '#FFFFFF' : appConfig.boardColor;
            drawnTextColorPicker.value = appConfig.drawnTextColor;
            drawnStrokeColorPicker.value = appConfig.drawnTextStrokeColor;
            drawnStrokeWidthSlider.value = appConfig.drawnTextStrokeWidth;
            drawnStrokeWidthValue.textContent = appConfig.drawnTextStrokeWidth;

            const inactiveTabClass = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500';
            const activeTabClass = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-sky-500 text-sky-400';
            
            tabAppearance.addEventListener('click', () => {
                contentAppearance.classList.remove('hidden');
                contentLabels.classList.add('hidden');
                contentShortcuts.classList.add('hidden');
                tabAppearance.className = activeTabClass;
                tabLabels.className = inactiveTabClass;
                tabShortcuts.className = inactiveTabClass;
            });
             tabLabels.addEventListener('click', () => {
                contentLabels.classList.remove('hidden');
                contentAppearance.classList.add('hidden');
                contentShortcuts.classList.add('hidden');
                tabLabels.className = activeTabClass;
                tabAppearance.className = inactiveTabClass;
                tabShortcuts.className = inactiveTabClass;
            });
            tabShortcuts.addEventListener('click', () => {
                contentShortcuts.classList.remove('hidden');
                contentAppearance.classList.add('hidden');
                contentLabels.classList.add('hidden');
                tabShortcuts.className = activeTabClass;
                tabAppearance.className = inactiveTabClass;
                tabLabels.className = inactiveTabClass;
            });

            removeCustomLogoBtn.addEventListener('click', () => customLogoInput.value = '');
            drawnStrokeWidthSlider.addEventListener('input', (e) => drawnStrokeWidthValue.textContent = e.target.value);
            resetColorBtn.addEventListener('click', () => colorPicker.value = '#FFFFFF');
            document.getElementById('generate-test-data-btn').addEventListener('click', generateTestData);

            document.getElementById('close-settings-btn').addEventListener('click', () => {
                appConfig.customLogoBase64 = customLogoInput.value.trim();
                appConfig.sponsorImagesBase64 = sponsorImagesInput.value.split('\n').map(s => s.trim()).filter(Boolean);
                appConfig.bingoTitle = titleSelect.value;
                appConfig.boardColor = colorPicker.value.toUpperCase();
                if (appConfig.boardColor === '#FFFFFF') appConfig.boardColor = 'default';
                appConfig.drawnTextColor = drawnTextColorPicker.value.toUpperCase();
                appConfig.drawnTextStrokeColor = drawnStrokeColorPicker.value.toUpperCase();
                appConfig.drawnTextStrokeWidth = parseInt(drawnStrokeWidthSlider.value, 10);
                
                document.querySelectorAll('[data-label-key-input]').forEach(input => {
                    appLabels[input.dataset.labelKeyInput] = input.value;
                });

                saveStateToFirestore();
                applyLabels();
                renderUIFromState();
                DOMElements.settingsModal.classList.add('hidden');
            });
            DOMElements.settingsModal.classList.remove('hidden');
        }

        function applyBoardZoom(scalePercent) {
            const scaleFactor = scalePercent / 100;
            DOMElements.bingoBoardWrapper.style.transform = `scale(${scaleFactor})`;
            const labelEl = document.querySelector('label[for="board-zoom-slider"]');
            if (labelEl) labelEl.textContent = `${appLabels.boardScaleLabel} (${scalePercent}%)`;
        }
        
        function applyDisplayZoom(scalePercent) {
            const scaleFactor = scalePercent / 100;
            DOMElements.currentNumberWrapper.style.transform = `scale(${scaleFactor})`;
            const labelEl = document.querySelector('label[for="display-zoom-slider"]');
            if (labelEl) labelEl.textContent = `${appLabels.displayScaleLabel} (${scalePercent}%)`;
        }
        
        function handleAuctionSale(event) {
            event.preventDefault();
            const itemName = document.getElementById('auction-item-name').value.trim();
            const bid = document.getElementById('auction-item-current-bid').value.trim();
            const winnerName = document.getElementById('auction-winner-name').value.trim();

            if (!itemName || !bid || !winnerName) {
                showAlert("Por favor, preencha todos os campos do leil√£o.");
                return;
            }

            if (!gamesData['Leil√£o']) gamesData['Leil√£o'] = { winners: [] };
            
            const auctionData = {
                id: Date.now(),
                name: winnerName,
                prize: `${itemName} (Leil√£o)`,
                gameNumber: 'Leil√£o',
                bingoType: 'Leil√£o',
                itemName: itemName,
                bid: bid
            };

            gamesData['Leil√£o'].winners.push(auctionData);
            renderAllWinners();
            DOMElements.shareBtn.classList.remove('hidden');
            DOMElements.endEventBtn.classList.remove('hidden');
            showCongratsModal(winnerName, `Arrematou "${itemName}" por R$ ${bid}`);
            
            const bidDisplay = document.getElementById('auction-current-bid-display');
            if (bidDisplay) bidDisplay.textContent = 'R$ 0';
            
            DOMElements.auctionForm.reset();
            saveStateToFirestore();
        }

        function handleQuickBid(amount) {
            const currentBidInput = document.getElementById('auction-item-current-bid');
            const currentBidDisplay = document.getElementById('auction-current-bid-display');
            const currentBid = parseFloat(currentBidInput.value) || 0;
            const newBid = currentBid + amount;
            currentBidInput.value = newBid;

            if (currentBidDisplay) {
                currentBidDisplay.textContent = `R$ ${newBid}`;
                currentBidDisplay.classList.remove('scale-110');
                void currentBidDisplay.offsetWidth;
                currentBidDisplay.classList.add('scale-110');
                setTimeout(() => currentBidDisplay.classList.remove('scale-110'), 200);
            }

            const gavelIcon = document.getElementById('gavel-icon');
            gavelIcon.classList.remove('animate-gavel-strike');
            void gavelIcon.offsetWidth; // Trigger reflow
            gavelIcon.classList.add('animate-gavel-strike');
        }

        function renderCustomLogo() {
            const logoContainer = document.getElementById('app-logo');
            if (appConfig.customLogoBase64) {
                logoContainer.innerHTML = `<img src="${appConfig.customLogoBase64}" alt="Logo do Evento" class="w-full h-full object-contain">`;
            } else {
                logoContainer.innerHTML = `<svg viewBox="0 0 100 100" class="logo-animation w-full h-full">
                        <defs>
                            <linearGradient id="gold-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FFD700;" />
                                <stop offset="100%" style="stop-color:#FFA500;" />
                            </linearGradient>
                        </defs>
                        <path fill="url(#gold-gradient)" d="M50 0 L61.2 34.5 L97.5 34.5 L68.1 55.9 L79.4 90.5 L50 69.1 L20.6 90.5 L31.9 55.9 L2.5 34.5 L38.8 34.5 Z" />
                        <text x="50" y="62" font-family="Inter, sans-serif" font-weight="900" font-size="30" fill="white" text-anchor="middle" stroke="rgba(0,0,0,0.5)" stroke-width="1">SP</text>
                    </svg>`;
            }
        }

        let particles = [];
        const colors = ["#fde047", "#f97316", "#22c55e", "#0ea5e9", "#ef4444", "#a855f7"];
        function setupConfettiCanvas() {
            DOMElements.confettiCanvas.width = window.innerWidth;
            DOMElements.confettiCanvas.height = window.innerHeight;
        }
        function startConfetti(continuous = false) {
            particles = [];
            for (let i = 0; i < 200; i++) particles.push({ x: Math.random() * DOMElements.confettiCanvas.width, y: Math.random() * DOMElements.confettiCanvas.height - DOMElements.confettiCanvas.height, vx: Math.random() * 10 - 5, vy: Math.random() * 5 + 2, radius: Math.random() * 5 + 2, color: colors[Math.floor(Math.random() * colors.length)], alpha: Math.random() * 0.5 + 0.5 });
            animateConfetti(continuous);
        }
        function stopConfetti() {
            cancelAnimationFrame(confettiAnimationId);
            if(confettiCtx) confettiCtx.clearRect(0, 0, DOMElements.confettiCanvas.width, DOMElements.confettiCanvas.height);
        }
        function animateConfetti(continuous) {
            if(!confettiCtx) return;
            confettiCtx.clearRect(0, 0, DOMElements.confettiCanvas.width, DOMElements.confettiCanvas.height);
            particles.forEach((p, index) => {
                p.y += p.vy; p.x += p.vx;
                if (!continuous) { p.vy += 0.05; p.alpha -= 0.005; }
                if (p.y > DOMElements.confettiCanvas.height) {
                    if (continuous) particles[index] = { x: Math.random() * DOMElements.confettiCanvas.width, y: -20, vx: Math.random() * 10 - 5, vy: Math.random() * 5 + 2, radius: Math.random() * 5 + 2, color: colors[Math.floor(Math.random() * colors.length)], alpha: Math.random() * 0.5 + 0.5 };
                    else p.alpha = 0;
                }
                if (p.alpha > 0) {
                    confettiCtx.globalAlpha = p.alpha;
                    confettiCtx.fillStyle = p.color;
                    confettiCtx.beginPath();
                    confettiCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    confettiCtx.fill();
                }
            });
            particles = particles.filter(p => p.alpha > 0);
            if (continuous && particles.length < 200) {
                 for (let i = 0; i < 5; i++) particles.push({ x: Math.random() * DOMElements.confettiCanvas.width, y: -20, vx: Math.random() * 10 - 5, vy: Math.random() * 5 + 2, radius: Math.random() * 5 + 2, color: colors[Math.floor(Math.random() * colors.length)], alpha: Math.random() * 0.5 + 0.5 });
            }
            if (particles.length > 0 || continuous) confettiAnimationId = requestAnimationFrame(() => animateConfetti(continuous));
        }
        
        function startMenuAnimation() {
            DOMElements.eventBreakModal.innerHTML = getModalTemplates().eventBreak;
            document.getElementById('close-break-modal-btn').addEventListener('click', () => { DOMElements.eventBreakModal.classList.add('hidden'); stopConfetti(); clearInterval(menuInterval); });
            clearInterval(menuInterval);

            const breakContentArea = document.getElementById('break-content-area');
            const sponsors = appConfig.sponsorImagesBase64 || [];
            const combinedContent = [...menuItems, ...sponsors];

            if (combinedContent.length === 0) {
                breakContentArea.innerHTML = '<p class="text-2xl text-slate-400 text-center">Nenhum item no card√°pio ou patrocinador para exibir.</p>';
                return;
            }

            breakContentArea.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 id="menu-title" contenteditable="true" class="text-3xl font-bold text-amber-400 focus:outline-none focus:ring-2 ring-amber-500 rounded-lg">Card√°pio & Patrocinadores</h3><button id="edit-menu-btn-modal" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Editar Card√°pio</button></div><div id="slideshow-container" class="flex-grow flex items-center justify-center relative overflow-hidden"></div>`;
            const slideshowContainer = document.getElementById('slideshow-container');
            
            let currentIndex = 0;
            const showNextItem = () => {
                const currentItem = combinedContent[currentIndex];
                let contentHtml;

                if (currentItem.startsWith('data:image')) { // √â uma imagem de patrocinador
                    contentHtml = `<img src="${currentItem}" class="max-h-full max-w-full object-contain animate-fade-in-up">`;
                } else { // √â um item de menu
                    contentHtml = `<div class="w-full text-6xl font-bold text-center animate-fade-in-up">${currentItem}</div>`;
                }

                slideshowContainer.innerHTML = contentHtml;
                currentIndex = (currentIndex + 1) % combinedContent.length;
            };

            showNextItem();
            menuInterval = setInterval(showNextItem, 5000);

            document.getElementById('edit-menu-btn-modal').addEventListener('click', () => {
                DOMElements.menuEditModal.innerHTML = getModalTemplates().menuEdit;
                document.getElementById('menu-textarea').value = menuItems.join('\n');
                DOMElements.menuEditModal.classList.remove('hidden');
                document.getElementById('save-menu-btn').addEventListener('click', () => {
                    menuItems = document.getElementById('menu-textarea').value.split('\n').filter(item => item.trim() !== '');
                    DOMElements.menuEditModal.classList.add('hidden');
                    startMenuAnimation();
                    saveStateToFirestore();
                });
                document.getElementById('cancel-menu-edit-btn').addEventListener('click', () => { DOMElements.menuEditModal.classList.add('hidden'); });
            });
        }

        function startFinalWinnerSlide(allWinners) {
            DOMElements.eventBreakModal.innerHTML = getModalTemplates().finalWinners;
            DOMElements.eventBreakModal.classList.remove('hidden');
            const displayEl = document.getElementById('current-winner-card');
            document.getElementById('version-footer-modal').innerText = currentVersion;
            document.getElementById('last-updated-footer-modal').innerText = VERSION_DATE;
            document.getElementById('donation-final-btn').addEventListener('click', () => {
                DOMElements.eventBreakModal.classList.add('hidden');
                showDonationModal();
                clearTimeout(winnerDisplayTimeout);
                stopConfetti();
            });
            let winnerIndex = 0;
            const showWinner = (winner) => {
                const prizeLabel = appLabels[winner.bingoType + 'Label'] || winner.bingoType;
                const winnerText = winner.bingoType === 'Sorteio' 
                    ? `<p class="text-4xl font-bold text-amber-400">Cartela ${winner.cartela}</p><p class="text-3xl text-white">${winner.name || 'Ganhador n√£o informado'}</p><p class="text-2xl text-sky-300 mt-2">Ganhou: ${winner.prize}</p>`
                    : `<p class="text-4xl font-bold text-amber-400">Rodada ${winner.gameNumber}</p><p class="text-3xl text-white">${winner.name || 'Ganhador n√£o informado'}</p><p class="text-2xl text-sky-300 mt-2">Pr√™mio: ${winner.prize} (${prizeLabel})</p>`;
                displayEl.style.opacity = 0;
                displayEl.style.transform = 'scale(0.9)';
                setTimeout(() => { displayEl.innerHTML = winnerText; displayEl.style.opacity = 1; displayEl.style.transform = 'scale(1)'; }, 500);
            };
            const nextWinner = () => {
                clearTimeout(winnerDisplayTimeout);
                if (allWinners.length === 0) { displayEl.innerHTML = `<p class="text-5xl font-black text-white">Nenhum vencedor registrado!</p>`; return; }
                showWinner(allWinners[winnerIndex]);
                winnerIndex = (winnerIndex + 1) % allWinners.length;
                winnerDisplayTimeout = setTimeout(nextWinner, winnerDisplayDuration);
            };
            nextWinner();
            startConfetti(true); 
            document.getElementById('generate-proof-final-btn').addEventListener('click', () => { showProofOptionsModal(); clearTimeout(winnerDisplayTimeout); stopConfetti(); DOMElements.eventBreakModal.classList.add('hidden'); });
            document.getElementById('close-final-modal-btn').addEventListener('click', () => { DOMElements.eventBreakModal.classList.add('hidden'); clearTimeout(winnerDisplayTimeout); stopConfetti(); });
        }
        
        function setupEventListeners() {
            DOMElements.startNewRoundBtn.addEventListener('click', showClearRoundConfirmModal);
            document.getElementById('clear-round-btn-bottom').addEventListener('click', showClearRoundConfirmModal);
            document.querySelectorAll('[data-label-key="verifyButton"]').forEach(btn => btn.addEventListener('click', showVerificationModal));
            DOMElements.manualInputForm.addEventListener('submit', handleManualInput);
            DOMElements.prizeDrawForm.addEventListener('submit', handlePrizeDraw);
            document.querySelector('[data-label-key="prizeDrawRandomButton"]').addEventListener('click', handleRandomPrizeDraw);
            DOMElements.checkDrawnPrizesBtn.addEventListener('click', showDrawnPrizesModal);
            DOMElements.shareBtn.addEventListener('click', showProofOptionsModal);
            DOMElements.showDonationModalBtn.addEventListener('click', showDonationModal);
            DOMElements.showChangelogBtn.addEventListener('click', showChangelogModal);
            DOMElements.showSettingsBtn.addEventListener('click', showSettingsModal);
            document.querySelectorAll('[data-label-key="autoDrawButton"]').forEach(btn => btn.addEventListener('click', handleAutoDraw));
            DOMElements.auctionForm.addEventListener('submit', handleAuctionSale);
            
            // Listeners para o leil√£o
            document.getElementById('add-50-bid').addEventListener('click', () => handleQuickBid(50));
            document.getElementById('add-100-bid').addEventListener('click', () => handleQuickBid(100));
            document.getElementById('add-custom-bid-btn').addEventListener('click', () => {
                const customAmount = parseFloat(document.getElementById('custom-bid-input').value) || 0;
                if (customAmount > 0) handleQuickBid(customAmount);
                document.getElementById('custom-bid-input').value = '';
            });
            const bidInput = document.getElementById('auction-item-current-bid');
            const bidDisplay = document.getElementById('auction-current-bid-display');
            if(bidInput && bidDisplay) {
                bidInput.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value) || 0;
                    bidDisplay.textContent = `R$ ${value}`;
                });
            }

            document.getElementById('board-zoom-slider')?.addEventListener('input', (e) => {
                const scale = parseInt(e.target.value, 10);
                appConfig.boardScale = scale;
                applyBoardZoom(scale);
                debouncedSave();
            });
            document.getElementById('display-zoom-slider')?.addEventListener('input', (e) => {
                const scale = parseInt(e.target.value, 10);
                appConfig.displayScale = scale;
                applyDisplayZoom(scale);
                debouncedSave();
            });
            document.querySelector('[data-label-key="howToUseButton"]')?.addEventListener('click', () => {
                if (appConfig.tutorialVideoLink && appConfig.tutorialVideoLink.startsWith('http')) window.open(appConfig.tutorialVideoLink, '_blank');
                else showAlert("O link do v√≠deo tutorial n√£o est√° configurado.");
            });

            DOMElements.endEventBtn.addEventListener('click', () => {
                const allWinners = Object.values(gamesData).flatMap(game => game.winners).filter(w => w.bingoType !== 'Sorteio').reverse();
                if (allWinners.length === 0) { showAlert("Nenhum vencedor foi registrado ainda."); return; }
                startFinalWinnerSlide(allWinners);
            });
            DOMElements.intervalBtn.addEventListener('click', () => { DOMElements.eventBreakModal.classList.remove('hidden'); startMenuAnimation(); startConfetti(true); });
            DOMElements.addExtraGameBtn.addEventListener('click', () => {
                gameCount++;
                gamesData[gameCount] = { 
                    prizes: {prize1: '', prize2: '', prize3: ''}, 
                    calledNumbers: [], 
                    winners: [], 
                    isComplete: false,
                    color: roundColors[gameCount % roundColors.length] 
                };
                DOMElements.gamesListEl.appendChild(createGameElement(gameCount, { prize1: '', prize2: '', prize3: '' }));
                saveStateToFirestore();
            });
            DOMElements.resetEventBtn.addEventListener('click', () => { 
                DOMElements.resetConfirmModal.innerHTML = getModalTemplates().resetConfirm;
                DOMElements.resetConfirmModal.classList.remove('hidden');
                document.getElementById('confirm-reset-btn').addEventListener('click', async () => { if (dbRef) await deleteDoc(dbRef); window.location.reload(); });
                document.getElementById('cancel-reset-btn').addEventListener('click', () => DOMElements.resetConfirmModal.classList.add('hidden'));
            });
            window.addEventListener('resize', setupConfettiCanvas);
            
            // Atalhos de teclado
            window.addEventListener('keydown', (e) => {
                const settingsModalVisible = !DOMElements.settingsModal.classList.contains('hidden');
                const shortcutInputFocused = settingsModalVisible && document.activeElement && document.activeElement.id.startsWith('shortcut-input-');

                if (e.target.isContentEditable || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || shortcutInputFocused) {
                    return;
                }

                const keyString = eventToShortcutString(e);
                if (!keyString) return;

                if (keyString === appConfig.shortcuts.autoDraw) {
                    e.preventDefault();
                    document.querySelector('#auto-draw-btn:not(:disabled)')?.click();
                } else if (keyString === appConfig.shortcuts.verify) {
                    e.preventDefault();
                    showVerificationModal();
                } else if (keyString === appConfig.shortcuts.clearRound) {
                    e.preventDefault();
                    showClearRoundConfirmModal();
                }
            });
        }

        async function startApp() {
            try {
                 const firebaseConfig = { apiKey: "AIzaSyDULAgBMD6g__7TuLgNIrjsEyC9es_gEZg", authDomain: "show-de-premios-65d20.firebaseapp.com", projectId: "show-de-premios-65d20", storageBucket: "show-de-pr√™mios-65d20.appspot.com", messagingSenderId: "454374708177", appId: "1:454374708177:web:7372a5fe967277973006f0", measurementId: "G-43DSKKVD0P" };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        dbRef = doc(db, 'artifacts', 'show-de-pr√™mios-netlify', 'users', userId);
                        firebaseReady = true;
                        DOMElements.connectionIndicator.classList.replace('bg-red-500', 'bg-green-500');
                        DOMElements.connectionStatusText.textContent = appLabels.connectionIndicatorConnected;
                        await loadStateFromFirestore(); 
                    }
                });
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showAlert("Falha ao conectar com o banco de dados. O progresso n√£o ser√° salvo.");
                applyLabels();
                renderUIFromState();
            }
            setupConfettiCanvas();
            setupEventListeners();
        }
        
        startApp();
    </script>
</body>
</html>